<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Black Sheep Restaurants - Beverage Database</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- SheetJS for Excel import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary: #2C3E50;
            --secondary: #34495E;
            --accent: #E67E22;
            --accent-light: #F39C12;
            --success: #27AE60;
            --danger: #E74C3C;
            --warning: #F1C40F;
            --light: #ECF0F1;
            --dark: #1E2B36;
            --white: #FFFFFF;
            --gray: #95A5A6;
            --sidebar-width: 280px;
            --profit: #27AE60;
            --loss: #E74C3C;
            --sheep-black: #000000;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* Mobile Menu Button - Burger Icon Only (No Logo) */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1002;
            background: var(--accent);
            color: var(--white);
            padding: 0.75rem 1rem;
            border-radius: 10px;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            color: var(--dark);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 1001;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .sidebar-header {
            margin-bottom: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--sheep-black);
        }

        .sheep-logo {
            width: 40px;
            height: 40px;
            background: var(--sheep-black);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .restaurant-badge {
            background: rgba(230,126,34,0.1);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            color: var(--accent);
            border: 1px solid rgba(230,126,34,0.3);
            font-weight: 600;
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1rem;
            border-radius: 12px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            font-weight: 500;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(230,126,34,0.1);
            color: var(--accent);
        }

        .nav-item i {
            width: 24px;
            text-align: center;
            color: var(--accent);
        }

        .favorites-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .favorites-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 1rem;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        .content-wrapper {
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
        }

        /* Header */
        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            color: var(--dark);
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Search Bar */
        .search-container {
            display: flex;
            align-items: center;
            background: var(--white);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            width: 400px;
            max-width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
        }

        .search-container i {
            color: var(--gray);
            margin-right: 0.5rem;
        }

        .search-container input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.95rem;
            background: transparent;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 0.5rem;
        }

        .search-result-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: rgba(230,126,34,0.1);
        }

        .search-result-category {
            font-size: 0.7rem;
            color: var(--accent);
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Alphabet Navigation */
        .alphabet-nav {
            position: sticky;
            top: 2rem;
            right: 0;
            float: right;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            background: var(--white);
            padding: 1rem 0.5rem;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-left: 1rem;
            z-index: 10;
        }

        .alphabet-letter {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .alphabet-letter:hover {
            background: rgba(230,126,34,0.1);
            color: var(--accent);
        }

        .alphabet-letter.active {
            background: var(--accent);
            color: white;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--white);
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: var(--light);
            transform: translateX(-4px);
        }

        /* Classic Cocktails Layout */
        .classic-container {
            display: flex;
            gap: 2rem;
            position: relative;
        }

        .classic-content {
            flex: 1;
        }

        /* PDF Preview Modal */
        .pdf-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .pdf-preview-content {
            background: var(--white);
            border-radius: 24px;
            padding: 2rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .pdf-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--accent);
        }

        .pdf-preview-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .pdf-preview-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .pdf-preview-close:hover {
            color: var(--danger);
        }

        .pdf-preview-options {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
        }

        /* Spirit Library Styles */
        .spirit-library-container {
            background: var(--white);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }

        .import-section {
            background: rgba(230,126,34,0.05);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px dashed var(--accent);
            text-align: center;
        }

        .import-area {
            border: 2px dashed var(--gray);
            border-radius: 12px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .import-area:hover {
            border-color: var(--accent);
            background: rgba(230,126,34,0.02);
        }

        .spirit-table {
            width: 100%;
            border-collapse: collapse;
        }

        .spirit-table th {
            background: var(--light);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
        }

        .spirit-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .spirit-table tr:hover {
            background: rgba(230,126,34,0.05);
        }

        .update-abv-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .update-abv-btn:hover {
            background: var(--accent-light);
        }

        /* Ingredient Autocomplete */
        .ingredient-search {
            position: relative;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .autocomplete-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .autocomplete-item:hover {
            background: rgba(230,126,34,0.1);
        }

        /* Venue Grid */
        .venue-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .venue-card {
            background: var(--white);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .venue-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 20px rgba(230,126,34,0.1);
            border-color: var(--accent);
        }

        .venue-drag-handle {
            position: absolute;
            top: 1rem;
            left: 1rem;
            cursor: move;
            color: var(--gray);
        }

        .venue-image {
            width: 100%;
            height: 160px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
            position: relative;
        }

        .venue-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .venue-image-upload {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .venue-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .venue-name-large {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .venue-location {
            color: var(--gray);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .venue-stats {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .venue-stat {
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .venue-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            width: 100%;
        }

        .venue-action-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.75rem;
        }

        .venue-edit-btn {
            background: var(--primary);
            color: white;
        }

        .venue-delete-btn {
            background: var(--danger);
            color: white;
        }

        .venue-overview-btn {
            background: var(--accent);
            color: white;
        }

        /* Cocktail List */
        .cocktail-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .cocktail-item {
            background: var(--white);
            border-radius: 16px;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
        }

        .cocktail-item:hover {
            background: rgba(230,126,34,0.05);
            transform: translateX(4px);
            border-color: var(--accent);
        }

        .cocktail-drag-handle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: move;
            color: var(--gray);
        }

        .cocktail-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .cocktail-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .cocktail-info {
            flex: 1;
        }

        .cocktail-name {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .cocktail-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--gray);
            align-items: center;
            flex-wrap: wrap;
        }

        .cogs-badge {
            background: rgba(230,126,34,0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .cogs-good {
            color: var(--profit);
        }

        .cogs-warning {
            color: var(--warning);
        }

        .cogs-high {
            color: var(--loss);
        }

        .share-btn {
            background: none;
            border: 1px solid var(--gray);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .share-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .edit-btn {
            background: none;
            border: 1px solid var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--primary);
        }

        .edit-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Cocktail Detail Page */
        .cocktail-detail {
            background: var(--white);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
        }

        .cocktail-silhouette {
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            opacity: 0.1;
            pointer-events: none;
            z-index: 1;
        }

        .cocktail-silhouette img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: left;
        }

        .detail-content {
            position: relative;
            z-index: 2;
        }

        .detail-header {
            display: flex;
            gap: 2rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .detail-image {
            width: 120px;
            height: 120px;
            border-radius: 16px;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
        }

        .detail-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-upload-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 3;
        }

        .detail-title {
            flex: 1;
        }

        .detail-name {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .detail-venue {
            color: var(--accent);
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Info Row */
        .info-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: center;
            padding: 1rem 0;
            border-top: 1px solid rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            margin: 1rem 0;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-item-label {
            font-size: 0.7rem;
            color: var(--gray);
            font-weight: 600;
            text-transform: uppercase;
        }

        .info-item-value {
            font-size: 0.95rem;
            color: var(--dark);
            font-weight: 500;
        }

        .selling-price {
            background: var(--accent);
            color: white !important;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            font-weight: 700;
        }

        .cogs-display {
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* Recipe Section */
        .recipe-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--accent);
            position: relative;
            z-index: 3;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Recipe Table */
        .recipe-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .recipe-table th {
            background: var(--light);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
        }

        .recipe-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .omit-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .ingredient-reference {
            color: var(--accent);
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }

        .ingredient-reference:hover {
            text-decoration: underline;
        }

        /* Scale Recipe Section */
        .scale-recipe-section {
            background: var(--white);
            border-radius: 20px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .scale-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scale-step {
            background: var(--light);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .scale-options {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .scale-option {
            flex: 1;
            min-width: 200px;
            background: var(--white);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .scale-option:hover {
            border-color: var(--accent);
            background: rgba(230,126,34,0.02);
        }

        .scale-option.active {
            border-color: var(--accent);
            background: rgba(230,126,34,0.05);
        }

        .scale-option-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .scale-option-desc {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .quantity-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .quantity-input {
            width: 120px;
            padding: 0.75rem;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            font-size: 1rem;
        }

        .quantity-label {
            font-size: 0.875rem;
            color: var(--gray);
        }

        .dilution-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .dilution-card {
            background: var(--white);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dilution-card:hover {
            border-color: var(--accent);
        }

        .dilution-card.active {
            border-color: var(--accent);
            background: rgba(230,126,34,0.05);
        }

        .dilution-percentage {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.25rem;
        }

        .dilution-desc {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .custom-dilution-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .calculate-recipe-btn {
            background: var(--accent);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 1rem;
            margin-top: 1.5rem;
        }

        .calculate-recipe-btn:hover {
            background: var(--accent-light);
            transform: scale(1.01);
        }

        .scaled-results {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--accent);
        }

        .water-note {
            background: rgba(52, 152, 219, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #2980b9;
        }

        .serving-note {
            background: rgba(39, 174, 96, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--success);
            font-weight: 600;
        }

        /* Method & Notes Section */
        .method-section {
            background: rgba(44,62,80,0.02);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .notes-section {
            background: rgba(230,126,34,0.05);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        /* Cocktail Overview Menu */
        .overview-container {
            background: var(--white);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }

        .overview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--accent);
        }

        .overview-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .overview-title i {
            color: var(--accent);
            margin-right: 0.5rem;
        }

        .overview-actions {
            display: flex;
            gap: 1rem;
        }

        .overview-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .overview-table th {
            background: var(--light);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            font-size: 0.875rem;
        }

        .overview-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-size: 0.875rem;
            vertical-align: top;
        }

        .overview-table .editable-price-input {
            width: 100px;
            padding: 0.5rem;
            border: 1px solid var(--accent);
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .ingredients-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ingredients-list li {
            padding: 0.25rem 0;
            border-bottom: 1px dashed rgba(0,0,0,0.05);
        }

        .ingredients-list li:last-child {
            border-bottom: none;
        }

        .overview-table tr:hover {
            background: rgba(230,126,34,0.05);
        }

        .cocktail-select-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        /* PDF Preview Styles */
        .pdf-preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .pdf-preview-table th {
            background: var(--light);
            padding: 0.75rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary);
        }

        .pdf-preview-table td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-size: 0.75rem;
        }

        .pdf-spec-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .pdf-spec-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--accent);
        }

        .pdf-spec-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .pdf-spec-family {
            color: var(--accent);
            font-size: 0.875rem;
        }

        /* Datalist for Cocktail Families */
        .family-datalist {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--accent-light);
            transform: scale(1.02);
        }

        .btn-pdf {
            background: #E74C3C;
            color: var(--white);
        }

        .btn-pdf:hover {
            background: #c0392b;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .btn-outline:hover {
            background: rgba(230,126,34,0.1);
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .btn-share {
            background: #3498db;
            color: white;
        }

        .btn-share:hover {
            background: #2980b9;
        }

        .btn-preview {
            background: #9b59b6;
            color: white;
        }

        .btn-preview:hover {
            background: #8e44ad;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--dark);
            color: var(--white);
            padding: 1rem 2rem;
            border-radius: 12px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 1001;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
                padding-top: 5rem;
            }

            .cocktail-silhouette {
                width: 150px;
            }

            .overview-table {
                display: block;
                overflow-x: auto;
            }

            .scale-options {
                flex-direction: column;
            }

            .overview-actions {
                flex-direction: column;
                width: 100%;
            }

            .classic-container {
                flex-direction: column;
            }

            .alphabet-nav {
                position: fixed;
                bottom: 1rem;
                right: 1rem;
                flex-direction: row;
                flex-wrap: wrap;
                max-width: 300px;
                background: var(--white);
                padding: 0.75rem;
                border-radius: 30px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button - Burger Icon Only (No Logo) -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="sheep-logo">
                        <i class="fas fa-sheep"></i>
                    </div>
                </div>
                <div class="restaurant-badge">
                    <i class="fas fa-star"></i> Black Sheep Restaurants
                </div>
            </div>

            <nav class="nav-links">
                <div class="nav-item" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-page="drinks">
                    <i class="fas fa-cocktail"></i>
                    <span>Drinks Library</span>
                </div>
                <div class="nav-item" data-page="classic">
                    <i class="fas fa-book"></i>
                    <span>Classic Cocktails</span>
                </div>
                <div class="nav-item" data-page="spirit-library">
                    <i class="fas fa-wine-bottle"></i>
                    <span>Spirit Library</span>
                </div>
                <div class="nav-item" data-page="infusion">
                    <i class="fas fa-flask"></i>
                    <span>Infusion</span>
                </div>
                <div class="nav-item" data-page="distillation">
                    <i class="fas fa-wine-bottle"></i>
                    <span>Distillation</span>
                </div>
            </nav>

            <div class="favorites-section">
                <div class="favorites-title">
                    <i class="fas fa-star"></i>
                    <span>Favorite Cocktails</span>
                </div>
                <div id="favoritesList" class="favorites-list">
                    <!-- Favorites will be dynamically added here -->
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-wrapper" id="mainContent">
                <!-- Content will be dynamically loaded here -->
            </div>
        </main>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" class="pdf-preview-modal">
        <div class="pdf-preview-content">
            <div class="pdf-preview-header">
                <h2 class="pdf-preview-title" id="pdfPreviewTitle">PDF Preview</h2>
                <button class="pdf-preview-close" onclick="closePDFPreview()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="pdfPreviewContent" style="max-height: 60vh; overflow-y: auto;">
                <!-- PDF Preview Content will be loaded here -->
            </div>
            <div class="pdf-preview-options">
                <button class="btn btn-outline" onclick="closePDFPreview()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-pdf" id="pdfDownloadBtn" onclick="downloadPDFFromPreview()">
                    <i class="fas fa-file-pdf"></i> Download PDF
                </button>
                <button class="btn btn-share" id="pdfShareBtn" onclick="sharePDFFromPreview()">
                    <i class="fas fa-share-alt"></i> Share
                </button>
            </div>
        </div>
    </div>

    <!-- Add Cocktail Modal -->
    <div id="addCocktailModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--white); border-radius: 24px; padding: 2rem; max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto; position: relative;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--accent);">
                <h2 class="modal-title" style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">
                    <i class="fas fa-plus-circle"></i> Add New Cocktail
                </h2>
                <button class="modal-close" onclick="closeModal('addCocktailModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="newCocktailForm" onsubmit="saveNewCocktail(event)">
                <!-- Venue Selection -->
                <div id="venueSelectionField" style="margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label" style="font-weight: 600; color: var(--primary);">Venue</label>
                        <select id="cocktailVenue" class="form-input" style="width: 100%; padding: 0.75rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px;" required>
                            <option value="">Select Venue...</option>
                        </select>
                    </div>
                </div>

                <!-- Category Tabs for Classic vs Signature -->
                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="category-tab" id="categorySignatureTab" style="flex: 1; text-align: center; background: var(--accent); color: white; border-color: var(--accent); padding: 0.75rem; border-radius: 12px; cursor: pointer;" onclick="setCocktailCategory('signature')">Signature</div>
                    <div class="category-tab" id="categoryClassicTab" style="flex: 1; text-align: center; background: var(--white); color: var(--dark); border: 1px solid rgba(0,0,0,0.05); padding: 0.75rem; border-radius: 12px; cursor: pointer;" onclick="setCocktailCategory('classic')">Classic</div>
                </div>
                <input type="hidden" id="cocktailCategory" value="signature">

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label" style="font-weight: 600; color: var(--primary);">Name</label>
                        <input type="text" id="cocktailName" class="form-input" placeholder="e.g., La Rochelle Martini" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-weight: 600; color: var(--primary);">Cocktail Family</label>
                        <input list="cocktailFamilies" id="cocktailFamily" class="family-datalist" placeholder="Select or type family" required>
                        <datalist id="cocktailFamilies">
                            <option value="Sour">
                            <option value="Collins">
                            <option value="Gimlet">
                            <option value="Rickey">
                            <option value="Sidecar">
                            <option value="Smash">
                            <option value="Manhattan">
                            <option value="Martini">
                            <option value="Old Fashioned">
                            <option value="Tiki">
                            <option value="NA">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-weight: 600; color: var(--primary);">Cost Price ($)</label>
                        <input type="number" id="cocktailCostPrice" class="form-input" step="0.01" min="0" placeholder="0.00" readonly style="background: var(--light);" value="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-weight: 600; color: var(--primary);">Selling Price ($)</label>
                        <input type="number" id="cocktailSellingPrice" class="form-input" step="0.01" min="0" placeholder="88.00" required onchange="calculateCOGS()">
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-weight: 600; color: var(--primary);">Glassware</label>
                        <input type="text" id="cocktailGlass" class="form-input" placeholder="e.g., Coupe" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-weight: 600; color: var(--primary);">Garnish</label>
                        <input type="text" id="cocktailGarnish" class="form-input" placeholder="e.g., Lemon Zest" required>
                    </div>
                </div>

                <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">
                    <i class="fas fa-flask"></i> Recipe Ingredients
                </h3>
                
                <table class="ingredient-table" style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                    <thead>
                        <tr style="background: var(--light);">
                            <th style="padding: 0.75rem; text-align: left;">Ingredient</th>
                            <th style="padding: 0.75rem; text-align: left;">Bottle (ml)</th>
                            <th style="padding: 0.75rem; text-align: left;">Cost ($)</th>
                            <th style="padding: 0.75rem; text-align: left;">Pour</th>
                            <th style="padding: 0.75rem; text-align: left;">Unit</th>
                            <th style="padding: 0.75rem; text-align: left;">Pour Cost</th>
                            <th style="padding: 0.75rem; text-align: left;">ABV %</th>
                            <th style="padding: 0.75rem; text-align: left;"></th>
                        </tr>
                    </thead>
                    <tbody id="ingredientTableBody">
                        <tr class="ingredient-row">
                            <td class="ingredient-search">
                                <input type="text" placeholder="Search or type ingredient" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onkeyup="searchIngredients(this)" autocomplete="off" required>
                                <div class="autocomplete-list" id="autocomplete-0"></div>
                            </td>
                            <td><input type="number" placeholder="750" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="50" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                            <td>
                                <select style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="convertUnit(this)">
                                    <option value="ml">ml</option>
                                    <option value="dash">dash</option>
                                </select>
                            </td>
                            <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="pour-cost"></td>
                            <td><input type="number" placeholder="40" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientABV(this)" required></td>
                            <td><button type="button" onclick="removeIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                </table>
                
                <button type="button" class="btn btn-outline" onclick="addIngredientRow()" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-plus"></i> Add Ingredient
                </button>

                <!-- Dilution Options - After Recipe Ingredients -->
                <div style="background: rgba(230,126,34,0.05); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--accent);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <i class="fas fa-tint" style="color: var(--accent);"></i>
                        <h3 style="color: var(--primary); font-size: 1.1rem; font-weight: 600;">Dilution</h3>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="dilutionPreset" id="dilutionShake" value="shake" style="accent-color: var(--accent);">
                            <label for="dilutionShake" style="font-weight: 500;">Shake <span style="color: var(--accent); font-weight: 700;">25%</span></label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="dilutionPreset" id="dilutionStir" value="stir" style="accent-color: var(--accent);">
                            <label for="dilutionStir" style="font-weight: 500;">Stir <span style="color: var(--accent); font-weight: 700;">20%</span></label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="dilutionPreset" id="dilutionBuild" value="build" style="accent-color: var(--accent);">
                            <label for="dilutionBuild" style="font-weight: 500;">Build <span style="color: var(--accent); font-weight: 700;">10%</span></label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="dilutionPreset" id="dilutionBlend" value="blend" style="accent-color: var(--accent);">
                            <label for="dilutionBlend" style="font-weight: 500;">Blend <span style="color: var(--accent); font-weight: 700;">50%</span></label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="dilutionPreset" id="dilutionNone" value="none" checked style="accent-color: var(--accent);">
                            <label for="dilutionNone" style="font-weight: 500;">No Dilution <span style="color: var(--accent); font-weight: 700;">0%</span></label>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                        <input type="checkbox" id="useCustomDilution" onchange="toggleCustomDilution()" style="accent-color: var(--accent);">
                        <label for="useCustomDilution" style="font-weight: 500;">Custom dilution</label>
                        <input type="number" id="customDilutionValue" class="form-input" placeholder="%" min="0" max="100" step="1" style="width: 80px; margin-left: 1rem; display: none;" disabled onchange="calculateFinalABV()">
                    </div>
                </div>

                <!-- Final ABV Live Display -->
                <div id="finalAbvLiveDisplay" style="background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%); color: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <span><i class="fas fa-percent"></i> Final ABV (after dilution)</span>
                    <span class="final-abv-value" id="finalAbvValue" style="font-size: 1.5rem; font-weight: 700;">0.0%</span>
                </div>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label" style="font-weight: 600; color: var(--primary);">Method</label>
                    <textarea id="cocktailMethod" class="form-input" placeholder="e.g., Stir over ice, strain into chilled coupe..." rows="2" required></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label" style="font-weight: 600; color: var(--primary);">Notes</label>
                    <textarea id="cocktailNotes" class="form-input" placeholder="Additional notes, variations, tips..." rows="2"></textarea>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addCocktailModal')">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Cocktail
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Infusion Modal - Same Template as Add Cocktail (Removed cocktail-specific fields) -->
    <div id="addInfusionModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--white); border-radius: 24px; padding: 2rem; max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-flask"></i> New Infusion
                </h2>
                <button class="modal-close" onclick="closeModal('addInfusionModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="newInfusionForm" onsubmit="saveNewInfusion(event)">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" id="infusionName" class="form-input" placeholder="e.g., Spiced Pineapple Infusion" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <input list="infusionCategories" id="infusionCategory" class="form-input" placeholder="e.g., Rum, Gin, Vodka">
                        <datalist id="infusionCategories">
                            <option value="Rum">
                            <option value="Gin">
                            <option value="Vodka">
                            <option value="Whiskey">
                            <option value="Tequila">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Base Spirit</label>
                        <input type="text" id="infusionBase" class="form-input" placeholder="e.g., Plantation 3 Star" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Author</label>
                        <input type="text" id="infusionAuthor" class="form-input" placeholder="e.g., Bar Manager" value="Bar Manager" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="text" id="infusionDate" class="form-input" value="${new Date().toLocaleDateString()}" readonly style="background: var(--light);">
                    </div>
                </div>

                <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">
                    <i class="fas fa-flask"></i> Recipe Ingredients
                </h3>
                
                <table class="ingredient-table" style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                    <thead>
                        <tr style="background: var(--light);">
                            <th style="padding: 0.75rem; text-align: left;">Ingredient</th>
                            <th style="padding: 0.75rem; text-align: left;">Bottle (ml)</th>
                            <th style="padding: 0.75rem; text-align: left;">Cost ($)</th>
                            <th style="padding: 0.75rem; text-align: left;">Pour (ml)</th>
                            <th style="padding: 0.75rem; text-align: left;">Pour Cost</th>
                            <th style="padding: 0.75rem; text-align: left;">ABV %</th>
                            <th style="padding: 0.75rem; text-align: left;">Scaling</th>
                            <th style="padding: 0.75rem; text-align: left;">Scaled Pour</th>
                            <th style="padding: 0.75rem; text-align: left;"></th>
                        </tr>
                    </thead>
                    <tbody id="infusionIngredientTableBody">
                        <tr class="infusion-ingredient-row">
                            <td><input type="text" placeholder="Ingredient" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="500" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="50" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="infusion-pour-cost"></td>
                            <td><input type="number" placeholder="47" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionTotalABV(this)" required></td>
                            <td><input type="number" class="infusion-scaling" value="3" min="0.1" step="0.1" style="width: 80px; padding: 0.5rem;" onchange="calculateInfusionScaling()"></td>
                            <td><input type="number" placeholder="0" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="infusion-scaled-pour"></td>
                            <td><button type="button" onclick="removeInfusionIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                </table>
                
                <button type="button" class="btn btn-outline" onclick="addInfusionIngredientRow()" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-plus"></i> Add Ingredient
                </button>

                <!-- Totals Row -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Total Pour (ml)</label>
                        <input type="number" id="infusionTotalPour" class="form-input" readonly style="background: var(--light);" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Pour Cost ($)</label>
                        <input type="number" id="infusionTotalPourCost" class="form-input" readonly style="background: var(--light);" value="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Scaled Pour (ml)</label>
                        <input type="number" id="infusionTotalScaledPour" class="form-input" readonly style="background: var(--light);" value="0">
                    </div>
                </div>

                <!-- Scaling & Yield -->
                <div style="background: rgba(230,126,34,0.05); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--accent);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <i class="fas fa-calculator" style="color: var(--accent);"></i>
                        <h3 style="color: var(--primary); font-size: 1.1rem; font-weight: 600;">Scaling</h3>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Global Scaling Factor</label>
                            <input type="number" id="infusionGlobalScaling" class="form-input" value="3" min="0.1" step="0.1" onchange="updateInfusionScalingFactor()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Yield (after 20% loss)</label>
                            <input type="number" id="infusionYield" class="form-input" readonly style="background: var(--light);" value="0">
                        </div>
                    </div>
                </div>

                <!-- Meta Data -->
                <div style="background: rgba(44,62,80,0.02); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-info-circle"></i> Meta Data
                    </h3>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Used in these drinks</label>
                        <input type="text" id="infusionUsedIn" class="form-input" placeholder="e.g., La Rochelle Martini, House Martini">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Instructions</label>
                        <textarea id="infusionInstructions" class="form-input" placeholder="Detailed infusion instructions..." rows="3"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Allergens</label>
                        <input type="text" id="infusionAllergens" class="form-input" placeholder="e.g., Nuts, Dairy, Gluten...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea id="infusionNotes" class="form-input" placeholder="Additional notes..." rows="2"></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addInfusionModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Infusion</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Distillation Modal - Same Template as Add Cocktail (Removed cocktail-specific fields) -->
    <div id="addDistillationModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--white); border-radius: 24px; padding: 2rem; max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-wine-bottle"></i> New Distillation
                </h2>
                <button class="modal-close" onclick="closeModal('addDistillationModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="newDistillationForm" onsubmit="saveNewDistillation(event)">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" id="distillationName" class="form-input" placeholder="e.g., House Gin" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <input list="distillationCategories" id="distillationCategory" class="form-input" placeholder="e.g., Gin, Vodka, Whiskey">
                        <datalist id="distillationCategories">
                            <option value="Gin">
                            <option value="Vodka">
                            <option value="Whiskey">
                            <option value="Rum">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Base Spirit</label>
                        <input type="text" id="distillationBase" class="form-input" placeholder="e.g., Neutral Spirit" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target ABV (%)</label>
                        <input type="number" id="distillationTargetABV" class="form-input" placeholder="47" step="0.1" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Author</label>
                        <input type="text" id="distillationAuthor" class="form-input" placeholder="e.g., Head Distiller" value="Head Distiller" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="text" id="distillationDate" class="form-input" value="${new Date().toLocaleDateString()}" readonly style="background: var(--light);">
                    </div>
                </div>

                <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">
                    <i class="fas fa-flask"></i> Botanicals
                </h3>
                
                <table class="ingredient-table" style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                    <thead>
                        <tr style="background: var(--light);">
                            <th style="padding: 0.75rem; text-align: left;">Botanical</th>
                            <th style="padding: 0.75rem; text-align: left;">Bottle (ml)</th>
                            <th style="padding: 0.75rem; text-align: left;">Cost ($)</th>
                            <th style="padding: 0.75rem; text-align: left;">Pour (ml)</th>
                            <th style="padding: 0.75rem; text-align: left;">Pour Cost</th>
                            <th style="padding: 0.75rem; text-align: left;">ABV %</th>
                            <th style="padding: 0.75rem; text-align: left;">Scaling</th>
                            <th style="padding: 0.75rem; text-align: left;">Scaled Pour</th>
                            <th style="padding: 0.75rem; text-align: left;"></th>
                        </tr>
                    </thead>
                    <tbody id="distillationIngredientTableBody">
                        <tr class="distillation-ingredient-row">
                            <td><input type="text" placeholder="Juniper" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="1000" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="30" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                            <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="distillation-pour-cost"></td>
                            <td><input type="number" placeholder="40" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationTotalABV(this)" required></td>
                            <td><input type="number" class="distillation-scaling" value="3" min="0.1" step="0.1" style="width: 80px; padding: 0.5rem;" onchange="calculateDistillationScaling()"></td>
                            <td><input type="number" placeholder="0" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="distillation-scaled-pour"></td>
                            <td><button type="button" onclick="removeDistillationIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                </table>
                
                <button type="button" class="btn btn-outline" onclick="addDistillationIngredientRow()" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-plus"></i> Add Botanical
                </button>

                <!-- Totals Row -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Total Pour (ml)</label>
                        <input type="number" id="distillationTotalPour" class="form-input" readonly style="background: var(--light);" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Pour Cost ($)</label>
                        <input type="number" id="distillationTotalPourCost" class="form-input" readonly style="background: var(--light);" value="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total Scaled Pour (ml)</label>
                        <input type="number" id="distillationTotalScaledPour" class="form-input" readonly style="background: var(--light);" value="0">
                    </div>
                </div>

                <!-- Scaling & Yield -->
                <div style="background: rgba(230,126,34,0.05); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--accent);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <i class="fas fa-calculator" style="color: var(--accent);"></i>
                        <h3 style="color: var(--primary); font-size: 1.1rem; font-weight: 600;">Scaling</h3>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Global Scaling Factor</label>
                            <input type="number" id="distillationGlobalScaling" class="form-input" value="3" min="0.1" step="0.1" onchange="updateDistillationScalingFactor()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Yield (after 20% loss)</label>
                            <input type="number" id="distillationYield" class="form-input" readonly style="background: var(--light);" value="0">
                        </div>
                    </div>
                </div>

                <!-- Meta Data -->
                <div style="background: rgba(44,62,80,0.02); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-info-circle"></i> Meta Data
                    </h3>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Used in these drinks</label>
                        <input type="text" id="distillationUsedIn" class="form-input" placeholder="e.g., House Martini, Negroni">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Instructions</label>
                        <textarea id="distillationInstructions" class="form-input" placeholder="Detailed distillation instructions..." rows="3"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Allergens</label>
                        <input type="text" id="distillationAllergens" class="form-input" placeholder="e.g., Nuts, Gluten...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea id="distillationNotes" class="form-input" placeholder="Additional notes..." rows="2"></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addDistillationModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Distillation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Venue Modal -->
    <div id="editVenueModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--white); border-radius: 24px; padding: 2rem; max-width: 500px; width: 95%;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-edit"></i> Edit Venue
                </h2>
                <button class="modal-close" onclick="closeModal('editVenueModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="editVenueForm" onsubmit="saveVenueChanges(event)">
                <input type="hidden" id="editVenueId">
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label">Venue Name</label>
                    <input type="text" id="editVenueName" class="form-input" required>
                </div>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label">Location</label>
                    <input type="text" id="editVenueLocation" class="form-input" required>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('editVenueModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cocktail Spec PDF Template (Hidden) -->
    <div id="cocktailSpecTemplate" style="display: none;">
        <div class="pdf-spec-container" style="padding: 2rem; max-width: 800px; margin: 0 auto; background: white; font-family: 'Inter', sans-serif;">
            <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #E67E22;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 0.5rem;">
                    <div style="width: 50px; height: 50px; background: #000000; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                        <i class="fas fa-sheep" style="font-size: 1.5rem;"></i>
                    </div>
                    <h1 style="color: #2C3E50; font-size: 2rem;"> BLACK SHEEP</h1>
                </div>
                <p style="color: #E67E22; font-weight: 600;">COCKTAIL SPEC</p>
            </div>
            
            <div id="pdfCocktailContent">
                <!-- Will be filled dynamically -->
            </div>
        </div>
    </div>

    <!-- Component Reference Modal -->
    <div id="componentReferenceModal" class="component-detail-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center;">
        <div class="component-detail-content" style="background: var(--white); border-radius: 24px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="color: var(--primary);"><i class="fas fa-flask"></i> Ingredient Details</h2>
                <button onclick="closeComponentModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div id="componentDetailContent">
                <!-- Component details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <script>
        // Constants
        const DASH_TO_ML = 0.92;

        // State Management
        const AppState = {
            venues: [
                {
                    id: 1,
                    name: "The Chinnery",
                    location: "Central",
                    image: "https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400",
                    order: 1,
                    cocktails: [
                        {
                            id: 101,
                            name: "Black Sheep Old Fashioned",
                            category: "signature",
                            family: "Old Fashioned",
                            favorite: true,
                            image: "https://images.unsplash.com/photo-1470337458703-46ad1756a187?w=400",
                            order: 1,
                            recipe: [
                                { ingredient: "House Bourbon", amount: 60, unit: "ml", bottleSize: 750, bottleCost: 45, pourCost: 3.60, abv: 45, spiritId: "spirit-001" },
                                { ingredient: "Demerara Syrup", amount: 10, unit: "ml", bottleSize: 1000, bottleCost: 25, pourCost: 0.25, abv: 0, spiritId: null },
                                { ingredient: "Angostura Bitters", amount: 3, unit: "dash", bottleSize: 200, bottleCost: 30, pourCost: 0.45, abv: 45, spiritId: null }
                            ],
                            pourCost: 4.30,
                            sellingPrice: 128,
                            cogs: 3.36,
                            finalAbv: 37.5,
                            method: "Stir all ingredients with ice for 30 seconds. Strain into rocks glass over large ice cube. Express orange peel and discard.",
                            garnish: "Orange twist",
                            glassware: "Rocks glass",
                            dateAdded: "2024-01-15",
                            author: "Bar Manager",
                            dilutionPreset: "stir",
                            notes: "Use large format ice cube. Express oil from orange peel over drink before discarding."
                        }
                    ]
                },
                {
                    id: 2,
                    name: "La Vache",
                    location: "SoHo",
                    image: "https://images.unsplash.com/photo-1550966871-3ed9cd9edce3?w=400",
                    order: 2,
                    cocktails: []
                },
                {
                    id: 3,
                    name: "New Punjab Club",
                    location: "Central",
                    image: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400",
                    order: 3,
                    cocktails: []
                }
            ],
            classicCocktails: [
                {
                    id: 1001,
                    name: "Classic Martini",
                    category: "classic",
                    family: "Martini",
                    image: "https://images.unsplash.com/photo-1575023782549-62ca0d244b39?w=400",
                    recipe: [
                        { ingredient: "London Dry Gin", amount: 60, unit: "ml", bottleSize: 700, bottleCost: 32, pourCost: 2.74, abv: 47, spiritId: null },
                        { ingredient: "Dry Vermouth", amount: 10, unit: "ml", bottleSize: 750, bottleCost: 28, pourCost: 0.37, abv: 18, spiritId: null }
                    ],
                    pourCost: 3.11,
                    sellingPrice: 120,
                    cogs: 2.59,
                    finalAbv: 39.2,
                    method: "Stir with ice, strain into chilled coupe. Garnish with lemon twist or olive.",
                    garnish: "Lemon twist or olive",
                    glassware: "Coupe",
                    dateAdded: "2024-01-10",
                    author: "Classic Recipe",
                    dilutionPreset: "stir"
                },
                {
                    id: 1002,
                    name: "Whiskey Sour",
                    category: "classic",
                    family: "Sour",
                    image: "https://images.unsplash.com/photo-1536935338788-846bb9981813?w=400",
                    recipe: [
                        { ingredient: "Bourbon", amount: 60, unit: "ml", bottleSize: 750, bottleCost: 38, pourCost: 3.04, abv: 40, spiritId: null },
                        { ingredient: "Lemon Juice", amount: 30, unit: "ml", bottleSize: 1000, bottleCost: 12, pourCost: 0.36, abv: 0, spiritId: null },
                        { ingredient: "Simple Syrup", amount: 15, unit: "ml", bottleSize: 1000, bottleCost: 15, pourCost: 0.23, abv: 0, spiritId: null },
                        { ingredient: "Egg White", amount: 15, unit: "ml", bottleSize: 500, bottleCost: 8, pourCost: 0.24, abv: 0, spiritId: null }
                    ],
                    pourCost: 3.87,
                    sellingPrice: 110,
                    cogs: 3.52,
                    finalAbv: 21.8,
                    method: "Dry shake, then shake with ice. Double strain into rocks glass.",
                    garnish: "Lemon wheel, cherry",
                    glassware: "Rocks glass",
                    dateAdded: "2024-01-10",
                    author: "Classic Recipe",
                    dilutionPreset: "shake"
                },
                {
                    id: 1003,
                    name: "Aviation",
                    category: "classic",
                    family: "Sour",
                    image: "https://images.unsplash.com/photo-1551024701-1b5e0d7d5c9e?w=400",
                    recipe: [
                        { ingredient: "Gin", amount: 60, unit: "ml", bottleSize: 700, bottleCost: 32, pourCost: 2.74, abv: 47, spiritId: null },
                        { ingredient: "Lemon Juice", amount: 15, unit: "ml", bottleSize: 1000, bottleCost: 12, pourCost: 0.18, abv: 0, spiritId: null },
                        { ingredient: "Maraschino Liqueur", amount: 15, unit: "ml", bottleSize: 700, bottleCost: 35, pourCost: 0.75, abv: 32, spiritId: null },
                        { ingredient: "Crme de Violette", amount: 5, unit: "ml", bottleSize: 500, bottleCost: 30, pourCost: 0.30, abv: 20, spiritId: null }
                    ],
                    pourCost: 3.97,
                    sellingPrice: 140,
                    cogs: 2.84,
                    finalAbv: 26.5,
                    method: "Shake with ice, strain into coupe. Garnish with cherry.",
                    garnish: "Cherry",
                    glassware: "Coupe",
                    dateAdded: "2024-01-15",
                    author: "Classic Recipe",
                    dilutionPreset: "shake"
                },
                {
                    id: 1004,
                    name: "Boulevardier",
                    category: "classic",
                    family: "Martini",
                    image: "https://images.unsplash.com/photo-1575023782549-62ca0d244b39?w=400",
                    recipe: [
                        { ingredient: "Bourbon", amount: 45, unit: "ml", bottleSize: 750, bottleCost: 38, pourCost: 2.28, abv: 40, spiritId: null },
                        { ingredient: "Campari", amount: 30, unit: "ml", bottleSize: 1000, bottleCost: 38, pourCost: 1.14, abv: 24, spiritId: null },
                        { ingredient: "Sweet Vermouth", amount: 30, unit: "ml", bottleSize: 750, bottleCost: 28, pourCost: 1.12, abv: 16, spiritId: null }
                    ],
                    pourCost: 4.54,
                    sellingPrice: 135,
                    cogs: 3.36,
                    finalAbv: 28.5,
                    method: "Stir with ice, strain into rocks glass over ice. Garnish with orange peel.",
                    garnish: "Orange peel",
                    glassware: "Rocks glass",
                    dateAdded: "2024-01-20",
                    author: "Classic Recipe",
                    dilutionPreset: "stir"
                },
                {
                    id: 1005,
                    name: "Cosmopolitan",
                    category: "classic",
                    family: "Sour",
                    image: "https://images.unsplash.com/photo-1556855810-ac404aa91e85?w=400",
                    recipe: [
                        { ingredient: "Vodka", amount: 45, unit: "ml", bottleSize: 700, bottleCost: 30, pourCost: 1.93, abv: 40, spiritId: null },
                        { ingredient: "Cranberry Juice", amount: 30, unit: "ml", bottleSize: 1000, bottleCost: 8, pourCost: 0.24, abv: 0, spiritId: null },
                        { ingredient: "Lime Juice", amount: 15, unit: "ml", bottleSize: 1000, bottleCost: 12, pourCost: 0.18, abv: 0, spiritId: null },
                        { ingredient: "Cointreau", amount: 15, unit: "ml", bottleSize: 700, bottleCost: 38, pourCost: 0.81, abv: 40, spiritId: null }
                    ],
                    pourCost: 3.16,
                    sellingPrice: 125,
                    cogs: 2.53,
                    finalAbv: 22.5,
                    method: "Shake with ice, strain into coupe. Garnish with lime wheel.",
                    garnish: "Lime wheel",
                    glassware: "Coupe",
                    dateAdded: "2024-01-25",
                    author: "Classic Recipe",
                    dilutionPreset: "shake"
                }
            ],
            spiritLibrary: [
                { id: "spirit-001", name: "House Bourbon", brand: "Wild Turkey 101", type: "Bourbon", abv: 50, bottleSize: 750, bottleCost: 45, notes: "High rye bourbon", supplier: "Wild Turkey", lastUpdated: "2024-01-15" },
                { id: "spirit-002", name: "Blended Scotch", brand: "Monkey Shoulder", type: "Scotch", abv: 40, bottleSize: 750, bottleCost: 38, notes: "Smooth blended malt", supplier: "William Grant & Sons", lastUpdated: "2024-01-15" },
                { id: "spirit-003", name: "Islay Scotch", brand: "Laphroaig 10", type: "Scotch", abv: 46, bottleSize: 750, bottleCost: 65, notes: "Peaty and smoky", supplier: "Beam Suntory", lastUpdated: "2024-01-15" },
                { id: "spirit-004", name: "House Gin", brand: "Beefeater", type: "Gin", abv: 47, bottleSize: 700, bottleCost: 32, notes: "London dry gin", supplier: "Pernod Ricard", lastUpdated: "2024-01-15" },
                { id: "spirit-005", name: "Indian Single Malt", brand: "Amrut", type: "Whisky", abv: 46, bottleSize: 700, bottleCost: 85, notes: "Single malt from India", supplier: "Amrut", lastUpdated: "2024-01-15" },
                { id: "spirit-006", name: "Tequila", brand: "Espoln", type: "Tequila", abv: 40, bottleSize: 700, bottleCost: 42, notes: "100% agave", supplier: "Campari Group", lastUpdated: "2024-01-15" }
            ],
            infusions: [],
            distillations: [],
            dilutionPresets: {
                "shake": 0.25,
                "stir": 0.20,
                "build": 0.10,
                "blend": 0.50,
                "none": 0,
                "spirit-driven": 0.18
            },
            currentPage: 'dashboard',
            currentView: 'venues',
            currentCategory: 'signature',
            selectedVenue: null,
            selectedCocktail: null,
            scaleMethod: 'serving',
            scaleQuantity: 1,
            dilutionType: 'none',
            customDilution: 0.20,
            omittedIngredients: [],
            includeWater: true,
            showScaledResults: false,
            selectedCocktailsForPrint: [],
            pdfPreviewData: null,
            pdfPreviewType: null,
            nextCocktailId: 303,
            nextClassicCocktailId: 1006,
            nextVenueId: 4,
            nextInfusionId: 1,
            nextDistillationId: 1,
            usedFamilies: ['Sour', 'Collins', 'Gimlet', 'Rickey', 'Sidecar', 'Smash', 'Manhattan', 'Martini', 'Old Fashioned', 'Tiki', 'NA'],
            searchResults: [],
            searchVisible: false
        };

        // DOM Elements
        const mainContent = document.getElementById('mainContent');
        const sidebar = document.getElementById('sidebar');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');

        // Mobile Menu Toggle
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        // Navigation - All menu items at same level
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                
                const page = item.dataset.page;
                AppState.currentPage = page;
                
                if (page === 'drinks') {
                    AppState.currentView = 'venues';
                    AppState.selectedVenue = null;
                    AppState.selectedCocktail = null;
                    renderVenuesGrid();
                } else if (page === 'dashboard') {
                    renderDashboard();
                } else if (page === 'classic') {
                    renderClassicCocktails();
                } else if (page === 'spirit-library') {
                    renderSpiritLibrary();
                } else if (page === 'infusion') {
                    renderInfusion();
                } else if (page === 'distillation') {
                    renderDistillation();
                }
                
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                }
            });
        });

        // Populate venue dropdown
        function populateVenueDropdown() {
            const select = document.getElementById('cocktailVenue');
            if (select) {
                select.innerHTML = '<option value="">Select Venue...</option>';
                AppState.venues.forEach(venue => {
                    select.innerHTML += `<option value="${venue.id}">${venue.name}</option>`;
                });
            }
        }

        // Set cocktail category (Classic vs Signature)
        function setCocktailCategory(category) {
            AppState.currentCategory = category;
            document.getElementById('cocktailCategory').value = category;
            
            const classicTab = document.getElementById('categoryClassicTab');
            const signatureTab = document.getElementById('categorySignatureTab');
            
            if (category === 'classic') {
                classicTab.style.background = 'var(--accent)';
                classicTab.style.color = 'white';
                classicTab.style.borderColor = 'var(--accent)';
                signatureTab.style.background = 'var(--white)';
                signatureTab.style.color = 'var(--dark)';
                signatureTab.style.borderColor = 'rgba(0,0,0,0.05)';
            } else {
                signatureTab.style.background = 'var(--accent)';
                signatureTab.style.color = 'white';
                signatureTab.style.borderColor = 'var(--accent)';
                classicTab.style.background = 'var(--white)';
                classicTab.style.color = 'var(--dark)';
                classicTab.style.borderColor = 'rgba(0,0,0,0.05)';
            }
        }

        // Convert unit (ml to dash, etc.)
        function convertUnit(select) {
            const row = select.closest('tr');
            const pourInput = row.cells[3].querySelector('input');
            const unit = select.value;
            
            // Store the original value in ml for calculation
            if (!row.dataset.originalMl) {
                row.dataset.originalMl = pourInput.value;
            }
            
            if (unit === 'dash') {
                // Convert ml to dashes (1 dash = 0.92ml)
                const mlValue = parseFloat(pourInput.value) || 0;
                const dashValue = mlValue / DASH_TO_ML;
                pourInput.value = dashValue.toFixed(1);
            } else {
                // Convert dashes to ml
                const dashValue = parseFloat(pourInput.value) || 0;
                const mlValue = dashValue * DASH_TO_ML;
                pourInput.value = mlValue.toFixed(1);
            }
            
            calculateIngredientCost(pourInput);
        }

        // Dashboard Page with Search
        function renderDashboard() {
            const totalCocktails = AppState.venues.reduce((acc, venue) => acc + venue.cocktails.length, 0) + AppState.classicCocktails.length;
            const totalSpirits = AppState.spiritLibrary.length;
            const totalInfusions = AppState.infusions.length;
            const totalDistillations = AppState.distillations.length;
            const favorites = AppState.venues.flatMap(v => v.cocktails.filter(c => c.favorite));
            
            mainContent.innerHTML = `
                <div class="top-header">
                    <h1 class="page-title">
                        <i class="fas fa-home"></i>
                        Dashboard
                    </h1>
                    <div class="search-container" style="position: relative;">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Quick search cocktails, spirits, venues..." id="globalSearch" onkeyup="handleGlobalSearch(this.value)">
                        <div id="globalSearchResults" class="search-results"></div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="background: var(--white); border-radius: 20px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-cocktail" style="color: var(--accent);"></i>
                                Total Cocktails
                            </div>
                        </div>
                        <h2 style="font-size: 3rem; color: var(--accent);">${totalCocktails}</h2>
                        <p style="color: var(--gray);">Across ${AppState.venues.length} venues + Classics</p>
                    </div>

                    <div style="background: var(--white); border-radius: 20px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-wine-bottle" style="color: var(--accent);"></i>
                                Spirit Library
                            </div>
                        </div>
                        <h2 style="font-size: 3rem; color: var(--accent);">${totalSpirits}</h2>
                        <p style="color: var(--gray);">Active spirits</p>
                    </div>

                    <div style="background: var(--white); border-radius: 20px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-star" style="color: var(--accent);"></i>
                                Favorites
                            </div>
                        </div>
                        <h2 style="font-size: 3rem; color: var(--accent);">${favorites.length}</h2>
                        <p style="color: var(--gray);">Starred cocktails</p>
                    </div>
                </div>

                <div style="background: var(--white); border-radius: 20px; padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--dark); display: flex; align-items: center; gap: 0.75rem;">
                            <i class="fas fa-fire"></i>
                            Recent Additions
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                        ${AppState.venues.flatMap(v => v.cocktails.slice(-2)).map(cocktail => {
                            const venue = AppState.venues.find(v => v.cocktails.includes(cocktail));
                            return `
                                <div style="background: rgba(44,62,80,0.02); border-radius: 12px; padding: 1rem; cursor: pointer;" 
                                     onclick="viewCocktailDetail(${venue.id}, ${cocktail.id})">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div style="width: 50px; height: 50px; border-radius: 8px; overflow: hidden;">
                                            <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=100'}" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        <div>
                                            <div style="font-weight: 600;">${cocktail.name}</div>
                                            <div style="font-size: 0.75rem; color: var(--gray);">${venue.name}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            // Add click outside listener to close search results
            document.addEventListener('click', function(e) {
                const searchContainer = document.querySelector('.search-container');
                if (searchContainer && !searchContainer.contains(e.target)) {
                    const results = document.getElementById('globalSearchResults');
                    if (results) results.style.display = 'none';
                }
            });
        }

        // Global Search Handler
        function handleGlobalSearch(query) {
            const searchTerm = query.toLowerCase();
            const resultsContainer = document.getElementById('globalSearchResults');
            
            if (searchTerm.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            const results = [];

            // Search signature cocktails
            AppState.venues.forEach(venue => {
                venue.cocktails.forEach(cocktail => {
                    if (cocktail.name.toLowerCase().includes(searchTerm) ||
                        cocktail.family?.toLowerCase().includes(searchTerm)) {
                        results.push({
                            type: 'Cocktail',
                            name: cocktail.name,
                            venue: venue.name,
                            action: () => viewCocktailDetail(venue.id, cocktail.id)
                        });
                    }
                });
            });

            // Search classic cocktails
            AppState.classicCocktails.forEach(cocktail => {
                if (cocktail.name.toLowerCase().includes(searchTerm) ||
                    cocktail.family?.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'Classic Cocktail',
                        name: cocktail.name,
                        venue: 'Classic',
                        action: () => viewClassicCocktailDetail(cocktail.id)
                    });
                }
            });

            // Search spirits
            AppState.spiritLibrary.forEach(spirit => {
                if (spirit.name.toLowerCase().includes(searchTerm) ||
                    spirit.brand.toLowerCase().includes(searchTerm) ||
                    spirit.type.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'Spirit',
                        name: spirit.name,
                        brand: spirit.brand,
                        action: () => {
                            AppState.currentPage = 'spirit-library';
                            renderSpiritLibrary();
                        }
                    });
                }
            });

            // Search venues
            AppState.venues.forEach(venue => {
                if (venue.name.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'Venue',
                        name: venue.name,
                        location: venue.location,
                        action: () => {
                            AppState.currentView = 'cocktails';
                            AppState.selectedVenue = venue.id;
                            renderCocktailList(venue.id);
                        }
                    });
                }
            });

            AppState.searchResults = results.slice(0, 10);

            if (results.length > 0) {
                resultsContainer.innerHTML = AppState.searchResults.map(result => `
                    <div class="search-result-item" onclick="executeSearchResult(this, ${JSON.stringify(result.action).replace(/"/g, '&quot;')})">
                        <div class="search-result-category">${result.type}</div>
                        <div style="font-weight: 600;">${result.name}</div>
                        <div style="font-size: 0.75rem; color: var(--gray);">${result.venue || result.brand || result.location || ''}</div>
                    </div>
                `).join('');
                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.innerHTML = '<div class="search-result-item" style="color: var(--gray);">No results found</div>';
                resultsContainer.style.display = 'block';
            }
        }

        // Execute search result
        function executeSearchResult(element, actionString) {
            // Parse and execute the action
            const action = eval('(' + actionString + ')');
            if (typeof action === 'function') {
                action();
            }
            
            // Hide results
            document.getElementById('globalSearchResults').style.display = 'none';
            
            // Clear search input
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) searchInput.value = '';
        }

        // Spirit Library - Import from Excel with ABV Auto-Update
        function renderSpiritLibrary() {
            mainContent.innerHTML = `
                <div class="top-header">
                    <h1 class="page-title">
                        <i class="fas fa-wine-bottle"></i>
                        Spirit Library
                    </h1>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-outline" onclick="exportSpiritLibrary()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-primary" onclick="document.getElementById('excelImport').click()">
                            <i class="fas fa-file-import"></i> Import Excel
                        </button>
                        <input type="file" id="excelImport" accept=".xlsx, .xls, .csv" style="display: none;" onchange="importSpiritLibrary(event)">
                    </div>
                </div>

                <div class="spirit-library-container">
                    <div class="import-section">
                        <div class="import-area" onclick="document.getElementById('excelImport').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem;"></i>
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">Import Spirit Library</h3>
                            <p style="color: var(--gray); margin-bottom: 1rem;">Upload Excel file to update spirit database</p>
                            <p style="font-size: 0.875rem; color: var(--accent);">Supported formats: .xlsx, .xls, .csv</p>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="color: var(--primary);">Current Spirit Inventory</h3>
                        <span style="background: var(--light); padding: 0.5rem 1rem; border-radius: 30px; font-weight: 600;">${AppState.spiritLibrary.length} items</span>
                    </div>

                    <table class="spirit-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Brand</th>
                                <th>Type</th>
                                <th>ABV</th>
                                <th>Bottle Size</th>
                                <th>Bottle Cost</th>
                                <th>Cost per ml</th>
                                <th>Last Updated</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${AppState.spiritLibrary.map(spirit => `
                                <tr>
                                    <td style="font-weight: 600;">${spirit.name}</td>
                                    <td>${spirit.brand}</td>
                                    <td>${spirit.type}</td>
                                    <td>${spirit.abv}%</td>
                                    <td>${spirit.bottleSize}ml</td>
                                    <td>$${spirit.bottleCost.toFixed(2)}</td>
                                    <td>$${(spirit.bottleCost / spirit.bottleSize).toFixed(3)}</td>
                                    <td>${spirit.lastUpdated || '2024-01-15'}</td>
                                    <td>
                                        <button class="update-abv-btn" onclick="updateSpiritABV('${spirit.id}')">
                                            <i class="fas fa-sync-alt"></i> Update ABV
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Update Spirit ABV from Internet
        function updateSpiritABV(spiritId) {
            const spirit = AppState.spiritLibrary.find(s => s.id === spiritId);
            if (!spirit) return;
            
            showToast(` Searching for ${spirit.name} ABV...`);
            
            // Simulate API call to get ABV data
            setTimeout(() => {
                // Mock ABV updates based on spirit type
                const abvUpdates = {
                    'House Bourbon': 50,
                    'Blended Scotch': 40,
                    'Islay Scotch': 46,
                    'House Gin': 47,
                    'Indian Single Malt': 46,
                    'Tequila': 40
                };
                
                if (abvUpdates[spirit.name]) {
                    spirit.abv = abvUpdates[spirit.name];
                    spirit.lastUpdated = new Date().toISOString().split('T')[0];
                    showToast(` Updated ${spirit.name} ABV to ${spirit.abv}%`);
                    renderSpiritLibrary();
                    updateAllCocktailCosts();
                } else {
                    // Random ABV update for demonstration
                    const newABV = Math.floor(Math.random() * 15) + 40; // 40-55%
                    spirit.abv = newABV;
                    spirit.lastUpdated = new Date().toISOString().split('T')[0];
                    showToast(` Updated ${spirit.name} ABV to ${spirit.abv}%`);
                    renderSpiritLibrary();
                    updateAllCocktailCosts();
                }
            }, 1000);
        }

        // Import Spirit Library from Excel
        function importSpiritLibrary(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheet];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                const newSpirits = [];
                jsonData.forEach((row, index) => {
                    if (row.Name || row.name || row.Spirit) {
                        const spirit = {
                            id: `spirit-import-${Date.now()}-${index}`,
                            name: row.Name || row.name || row.Spirit || 'Unknown',
                            brand: row.Brand || row.brand || '',
                            type: row.Type || row.type || row.Category || 'Spirit',
                            abv: parseFloat(row.ABV || row.Abv || row.abv || 40),
                            bottleSize: parseFloat(row['Bottle Size'] || row.bottleSize || row.Volume || 750),
                            bottleCost: parseFloat(row['Bottle Cost'] || row.bottleCost || row.Cost || 0),
                            notes: row.Notes || row.notes || '',
                            supplier: row.Supplier || row.supplier || '',
                            lastUpdated: new Date().toISOString().split('T')[0]
                        };
                        newSpirits.push(spirit);
                    }
                });

                if (newSpirits.length > 0) {
                    AppState.spiritLibrary = newSpirits;
                    showToast(` Imported ${newSpirits.length} spirits successfully`);
                    updateAllCocktailCosts();
                    renderSpiritLibrary();
                } else {
                    showToast(' No valid spirit data found in file');
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        // Export Spirit Library to Excel
        function exportSpiritLibrary() {
            const exportData = AppState.spiritLibrary.map(spirit => ({
                'Name': spirit.name,
                'Brand': spirit.brand,
                'Type': spirit.type,
                'ABV': spirit.abv,
                'Bottle Size (ml)': spirit.bottleSize,
                'Bottle Cost ($)': spirit.bottleCost,
                'Cost per ml ($)': (spirit.bottleCost / spirit.bottleSize).toFixed(3),
                'Supplier': spirit.supplier || '',
                'Notes': spirit.notes || '',
                'Last Updated': spirit.lastUpdated || ''
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            XLSX.utils.book_append_sheet(wb, ws, 'Spirit Library');
            XLSX.writeFile(wb, `Spirit_Library_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast(' Spirit library exported successfully');
        }

        // Update all cocktail costs when spirit prices change
        function updateAllCocktailCosts() {
            AppState.venues.forEach(venue => {
                venue.cocktails.forEach(cocktail => {
                    cocktail.recipe.forEach(item => {
                        if (item.spiritId) {
                            const spirit = AppState.spiritLibrary.find(s => s.id === item.spiritId);
                            if (spirit) {
                                item.bottleSize = spirit.bottleSize;
                                item.bottleCost = spirit.bottleCost;
                                item.abv = spirit.abv;
                                item.pourCost = (item.amount / item.bottleSize) * item.bottleCost;
                            }
                        }
                    });
                    
                    cocktail.pourCost = cocktail.recipe.reduce((sum, item) => sum + (item.pourCost || 0), 0);
                    cocktail.cogs = (cocktail.pourCost / cocktail.sellingPrice * 100).toFixed(1);
                    
                    const totalAlcohol = cocktail.recipe.reduce((acc, item) => acc + (item.amount * (item.abv / 100)), 0);
                    const totalVolume = cocktail.recipe.reduce((acc, item) => acc + item.amount, 0);
                    const dilutionFactor = AppState.dilutionPresets[cocktail.dilutionPreset] || 0.25;
                    cocktail.finalAbv = totalVolume > 0 ? (totalAlcohol / totalVolume) / (1 + dilutionFactor) * 100 : 0;
                });
            });

            AppState.classicCocktails.forEach(cocktail => {
                cocktail.recipe.forEach(item => {
                    if (item.spiritId) {
                        const spirit = AppState.spiritLibrary.find(s => s.id === item.spiritId);
                        if (spirit) {
                            item.bottleSize = spirit.bottleSize;
                            item.bottleCost = spirit.bottleCost;
                            item.abv = spirit.abv;
                            item.pourCost = (item.amount / item.bottleSize) * item.bottleCost;
                        }
                    }
                });
                
                cocktail.pourCost = cocktail.recipe.reduce((sum, item) => sum + (item.pourCost || 0), 0);
                cocktail.cogs = (cocktail.pourCost / cocktail.sellingPrice * 100).toFixed(1);
                
                const totalAlcohol = cocktail.recipe.reduce((acc, item) => acc + (item.amount * (item.abv / 100)), 0);
                const totalVolume = cocktail.recipe.reduce((acc, item) => acc + item.amount, 0);
                const dilutionFactor = AppState.dilutionPresets[cocktail.dilutionPreset] || 0.25;
                cocktail.finalAbv = totalVolume > 0 ? (totalAlcohol / totalVolume) / (1 + dilutionFactor) * 100 : 0;
            });

            showToast(' All cocktail costs updated from spirit library');
        }

        // Search ingredients in spirit library
        function searchIngredients(input) {
            const searchTerm = input.value.toLowerCase();
            const autocompleteList = input.parentElement.querySelector('.autocomplete-list');
            
            if (searchTerm.length < 1) {
                autocompleteList.style.display = 'none';
                return;
            }

            const matches = AppState.spiritLibrary.filter(spirit => 
                spirit.name.toLowerCase().includes(searchTerm) || 
                spirit.brand.toLowerCase().includes(searchTerm)
            ).slice(0, 5);

            if (matches.length > 0) {
                autocompleteList.innerHTML = matches.map(spirit => `
                    <div class="autocomplete-item" onclick="selectIngredient(this, '${spirit.id}', '${spirit.name}', ${spirit.bottleSize}, ${spirit.bottleCost}, ${spirit.abv})">
                        <strong>${spirit.name}</strong> - ${spirit.brand}<br>
                        <small>${spirit.bottleSize}ml | $${spirit.bottleCost.toFixed(2)} | ${spirit.abv}% ABV</small>
                    </div>
                `).join('');
                autocompleteList.style.display = 'block';
            } else {
                autocompleteList.style.display = 'none';
            }
        }

        // Select ingredient from autocomplete
        function selectIngredient(element, spiritId, name, bottleSize, bottleCost, abv) {
            const row = element.closest('tr');
            const inputs = row.querySelectorAll('input');
            
            inputs[0].value = name;
            inputs[1].value = bottleSize;
            inputs[2].value = bottleCost;
            inputs[6].value = abv;
            
            row.dataset.spiritId = spiritId;
            
            const autocompleteList = row.querySelector('.autocomplete-list');
            autocompleteList.style.display = 'none';
            
            calculateIngredientCost(inputs[3]);
            showToast(` Selected ${name} from Spirit Library`);
        }

        // Venues Grid
        function renderVenuesGrid() {
            const sortedVenues = [...AppState.venues].sort((a, b) => a.order - b.order);
            
            mainContent.innerHTML = `
                <div class="top-header">
                    <h1 class="page-title">
                        <i class="fas fa-store"></i>
                        Venues
                    </h1>
                    <button class="btn btn-primary" onclick="openAddVenueModal()">
                        <i class="fas fa-plus"></i> New Venue
                    </button>
                </div>

                <div class="venue-grid" id="venueGrid">
                    ${sortedVenues.map(venue => `
                        <div class="venue-card" data-id="${venue.id}" data-order="${venue.order}">
                            <div class="venue-drag-handle">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                            <div class="venue-image">
                                <img src="${venue.image || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400'}" alt="${venue.name}">
                                <div class="venue-image-upload" onclick="event.stopPropagation(); document.getElementById('venueImageUpload_${venue.id}').click()">
                                    <i class="fas fa-camera"></i> Change
                                    <input type="file" id="venueImageUpload_${venue.id}" accept="image/*" style="display: none;" onchange="uploadVenueImage(${venue.id}, event)">
                                </div>
                            </div>
                            <div class="venue-info">
                                <div class="venue-name-large">
                                    ${venue.name}
                                </div>
                                <div class="venue-location">
                                    <i class="fas fa-location-dot"></i> ${venue.location}
                                </div>
                                <div class="venue-stats">
                                    <div class="venue-stat" onclick="selectVenue(${venue.id})">
                                        <i class="fas fa-cocktail"></i> ${venue.cocktails.length} Cocktails
                                    </div>
                                </div>
                                <div class="venue-actions">
                                    <button class="venue-action-btn venue-edit-btn" onclick="event.stopPropagation(); editVenue(${venue.id})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="venue-action-btn venue-overview-btn" onclick="event.stopPropagation(); viewCocktailOverview(${venue.id})">
                                        <i class="fas fa-list"></i> Menu
                                    </button>
                                    <button class="venue-action-btn venue-delete-btn" onclick="event.stopPropagation(); deleteVenue(${venue.id})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            setTimeout(() => {
                const venueGrid = document.getElementById('venueGrid');
                if (venueGrid) {
                    new Sortable(venueGrid, {
                        animation: 150,
                        handle: '.venue-drag-handle',
                        onEnd: function(evt) {
                            updateVenueOrder();
                        }
                    });
                }
            }, 100);
        }

        // Classic Cocktails Library with Alphabet Navigation
        function renderClassicCocktails() {
            // Sort cocktails alphabetically
            const sortedClassics = [...AppState.classicCocktails].sort((a, b) => a.name.localeCompare(b.name));
            
            // Group cocktails by first letter
            const groupedCocktails = {};
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            
            alphabet.forEach(letter => {
                groupedCocktails[letter] = sortedClassics.filter(c => 
                    c.name.charAt(0).toUpperCase() === letter
                );
            });

            mainContent.innerHTML = `
                <div class="top-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <h1 class="page-title" style="margin-left: 0;">
                            <i class="fas fa-book"></i>
                            Classic Cocktails
                        </h1>
                    </div>
                    <button class="btn btn-primary" onclick="openAddClassicCocktailModal()">
                        <i class="fas fa-plus"></i> New Classic
                    </button>
                </div>

                <div class="classic-container">
                    <div class="classic-content">
                        <div class="cocktail-list">
                            ${alphabet.map(letter => {
                                const cocktails = groupedCocktails[letter];
                                if (cocktails && cocktails.length > 0) {
                                    return `
                                        <div id="letter-${letter}" style="margin-bottom: 1rem;">
                                            <div style="background: var(--accent); color: white; padding: 0.5rem 1rem; border-radius: 30px; display: inline-block; margin-bottom: 0.5rem; font-weight: 600;">
                                                ${letter}
                                            </div>
                                            ${cocktails.map(cocktail => `
                                                <div class="cocktail-item" onclick="viewClassicCocktailDetail(${cocktail.id})">
                                                    <div class="cocktail-thumbnail">
                                                        <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=100'}" alt="${cocktail.name}">
                                                    </div>
                                                    <div class="cocktail-info">
                                                        <div class="cocktail-name">
                                                            ${cocktail.name}
                                                            <span style="margin-left: 0.5rem; background: rgba(230,126,34,0.1); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem;">
                                                                ${cocktail.family}
                                                            </span>
                                                        </div>
                                                        <div class="cocktail-meta">
                                                            <span><i class="fas fa-wine-glass"></i> ${cocktail.glassware}</span>
                                                            <span><i class="fas fa-leaf"></i> ${cocktail.garnish}</span>
                                                            <span><i class="fas fa-percent"></i> ${cocktail.finalAbv.toFixed(1)}% ABV</span>
                                                            <span class="cogs-badge ${cocktail.cogs < 25 ? 'cogs-good' : cocktail.cogs < 35 ? 'cogs-warning' : 'cogs-high'}">
                                                                COGS: ${cocktail.cogs}%
                                                            </span>
                                                            <button class="edit-btn" onclick="event.stopPropagation(); editClassicCocktail(${cocktail.id})">
                                                                <i class="fas fa-edit"></i> Edit
                                                            </button>
                                                            <button class="share-btn" onclick="event.stopPropagation(); shareCocktailSpec(${cocktail.id}, 'classic')">
                                                                <i class="fas fa-share-alt"></i> Share
                                                            </button>
                                                        </div>
                                                        <div style="margin-top: 0.5rem; color: var(--gray); font-size: 0.875rem;">
                                                            ${cocktail.recipe.length} ingredients  $${cocktail.sellingPrice}
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `;
                                }
                                return '';
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Alphabet Navigation -->
                    <div class="alphabet-nav">
                        ${alphabet.map(letter => `
                            <div class="alphabet-letter ${groupedCocktails[letter] && groupedCocktails[letter].length > 0 ? '' : ''}" 
                                 onclick="document.getElementById('letter-${letter}')?.scrollIntoView({behavior: 'smooth'})"
                                 style="${!groupedCocktails[letter] || groupedCocktails[letter].length === 0 ? 'opacity: 0.3; cursor: default;' : ''}">
                                ${letter}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // View Classic Cocktail Detail
        function viewClassicCocktailDetail(cocktailId) {
            AppState.currentView = 'detail';
            AppState.selectedVenue = 'classic';
            AppState.selectedCocktail = cocktailId;
            AppState.scaleMethod = 'serving';
            AppState.scaleQuantity = 1;
            AppState.dilutionType = 'none';
            AppState.customDilution = 0.20;
            AppState.showScaledResults = false;
            AppState.omittedIngredients = [];
            
            renderClassicCocktailDetail(cocktailId);
        }

        // Classic Cocktail Detail Page
        function renderClassicCocktailDetail(cocktailId) {
            const cocktail = AppState.classicCocktails.find(c => c.id === cocktailId);
            
            if (!cocktail) return;

            let dilutionFactor = AppState.dilutionPresets[AppState.dilutionType] || 0;
            if (AppState.dilutionType === 'custom') {
                dilutionFactor = AppState.customDilution;
            }

            const activeRecipe = cocktail.recipe;

            const totalPreDilutionVolume = activeRecipe.reduce((acc, item) => {
                if (item.unit === 'ml') return acc + item.amount;
                if (item.unit === 'dash') return acc + (item.amount * DASH_TO_ML);
                if (item.unit === 'oz') return acc + (item.amount * 29.5735);
                return acc;
            }, 0);

            const scaleFactor = AppState.scaleMethod === 'serving' 
                ? AppState.scaleQuantity / 1
                : AppState.scaleQuantity / totalPreDilutionVolume;
            
            const waterAmount = AppState.showScaledResults && dilutionFactor > 0 ? totalPreDilutionVolume * dilutionFactor * scaleFactor : 0;
            
            let scaledRecipe = [];
            let totalVolume = 0;
            let batchCost = 0;
            let batchRevenue = 0;
            let finalAbv = 0;
            let servingsFromVolume = 0;
            
            if (AppState.showScaledResults) {
                scaledRecipe = activeRecipe.map(item => ({
                    ...item,
                    scaledAmount: (item.amount * scaleFactor).toFixed(1)
                }));

                if (AppState.includeWater && waterAmount > 0) {
                    scaledRecipe.push({
                        ingredient: "Water (dilution)",
                        amount: 0,
                        scaledAmount: waterAmount.toFixed(1),
                        unit: "ml",
                        pourCost: 0,
                        abv: 0,
                        isWater: true
                    });
                }

                totalVolume = scaledRecipe.reduce((acc, item) => acc + parseFloat(item.scaledAmount), 0);
                batchCost = activeRecipe.reduce((acc, item) => acc + (item.pourCost * scaleFactor), 0);
                batchRevenue = (cocktail.sellingPrice * (AppState.scaleMethod === 'serving' ? AppState.scaleQuantity : totalVolume / 150));
                servingsFromVolume = Math.round(totalVolume / 150);
                
                const totalAlcohol = activeRecipe.reduce((acc, item) => acc + (item.amount * (item.abv / 100)), 0);
                finalAbv = totalPreDilutionVolume > 0 
                    ? (totalAlcohol / totalPreDilutionVolume) / (1 + dilutionFactor) * 100 
                    : 0;
            }

            mainContent.innerHTML = `
                <div class="top-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="back-button" onclick="renderClassicCocktails()">
                            <i class="fas fa-arrow-left"></i> Back to Classics
                        </button>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="editClassicCocktail(${cocktail.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-pdf" onclick="printClassicCocktailSpec(${cocktail.id})">
                            <i class="fas fa-file-pdf"></i> Print Spec
                        </button>
                        <button class="btn btn-share" onclick="shareCocktailSpec(${cocktail.id}, 'classic')">
                            <i class="fas fa-share-alt"></i> Share
                        </button>
                    </div>
                </div>

                <div class="cocktail-detail">
                    <div class="cocktail-silhouette">
                        <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400'}" alt="silhouette">
                    </div>

                    <div class="detail-content">
                        <div class="detail-header">
                            <div class="detail-image">
                                <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400'}" alt="${cocktail.name}" id="cocktailDetailImage">
                            </div>
                            <div class="detail-title">
                                <div class="detail-name">${cocktail.name}</div>
                                <div class="detail-venue">
                                    <i class="fas fa-book"></i> Classic Cocktails
                                    <span style="margin-left: 1rem; background: rgba(230,126,34,0.1); padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.875rem;">
                                        ${cocktail.family}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-item">
                                <span class="info-item-label">Glassware</span>
                                <span class="info-item-value">${cocktail.glassware}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Garnish</span>
                                <span class="info-item-value">${cocktail.garnish}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Final ABV</span>
                                <span class="info-item-value">${cocktail.finalAbv.toFixed(1)}%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Added</span>
                                <span class="info-item-value">${cocktail.dateAdded || '2024-01-15'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Author</span>
                                <span class="info-item-value">${cocktail.author || 'Classic Recipe'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label selling-price">Selling Price</span>
                                <span class="info-item-value selling-price">$${cocktail.sellingPrice}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">COGS</span>
                                <span class="info-item-value cogs-display ${cocktail.cogs < 25 ? 'cogs-good' : cocktail.cogs < 35 ? 'cogs-warning' : 'cogs-high'}">
                                    ${cocktail.cogs}%
                                </span>
                            </div>
                        </div>

                        <div class="recipe-section">
                            <div class="section-title">
                                <i class="fas fa-flask"></i> Recipe
                            </div>

                            <table class="recipe-table">
                                <thead>
                                    <tr>
                                        <th>Ingredient</th>
                                        <th>Amount</th>
                                        <th>Unit</th>
                                        <th>Pour Cost</th>
                                        <th>ABV</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${cocktail.recipe.map((item) => {
                                        return `
                                            <tr>
                                                <td>
                                                    <span class="ingredient-reference" onclick="showIngredientReference('${item.spiritId || ''}', '${item.ingredient}')">
                                                        ${item.ingredient}
                                                    </span>
                                                </td>
                                                <td>${item.amount}</td>
                                                <td>${item.unit}</td>
                                                <td>$${item.pourCost ? item.pourCost.toFixed(2) : '0.00'}</td>
                                                <td>${item.abv}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>

                            <div class="method-section">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <i class="fas fa-flask" style="color: var(--accent);"></i>
                                    <span style="font-weight: 600; color: var(--primary);">Method</span>
                                </div>
                                <p style="color: var(--dark); line-height: 1.6;">${cocktail.method}</p>
                            </div>

                            ${cocktail.notes ? `
                                <div class="notes-section">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                        <i class="fas fa-sticky-note" style="color: var(--accent);"></i>
                                        <span style="font-weight: 600; color: var(--primary);">Notes</span>
                                    </div>
                                    <p style="color: var(--dark); line-height: 1.6;">${cocktail.notes}</p>
                                </div>
                            ` : ''}

                            <div class="scale-recipe-section">
                                <div class="scale-title">
                                    <i class="fas fa-calculator"></i> SCALE RECIPE
                                </div>

                                <div class="scale-step">
                                    <div class="step-header">
                                        <div class="step-number">1</div>
                                        <div class="step-title">CHOOSE SCALING METHOD</div>
                                    </div>
                                    <div class="scale-options">
                                        <div class="scale-option ${AppState.scaleMethod === 'serving' ? 'active' : ''}" onclick="setScaleMethod('serving', 'classic', ${cocktail.id})">
                                            <div class="scale-option-title">SCALE BY NUMBER OF SERVINGS</div>
                                            <div class="scale-option-desc">Choose this if you know how many servings you need.</div>
                                        </div>
                                        <div class="scale-option ${AppState.scaleMethod === 'volume' ? 'active' : ''}" onclick="setScaleMethod('volume', 'classic', ${cocktail.id})">
                                            <div class="scale-option-title">SCALE BY TOTAL VOLUME (ML)</div>
                                            <div class="scale-option-desc">Ideal for filling a specific container or batch size.</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="scale-step">
                                    <div class="step-header">
                                        <div class="step-number">2</div>
                                        <div class="step-title">ENTER QUANTITY</div>
                                    </div>
                                    <div class="quantity-input-group">
                                        <input type="number" id="scaleQuantityInput" class="quantity-input" 
                                               value="${AppState.scaleQuantity}" min="0.1" step="0.1" 
                                               onchange="updateScaleQuantity(this.value, 'classic', ${cocktail.id})">
                                        <span class="quantity-label">${AppState.scaleMethod === 'serving' ? 'SERVINGS' : 'MILLILITERS (ML)'}</span>
                                    </div>
                                </div>

                                <div class="scale-step">
                                    <div class="step-header">
                                        <div class="step-number">3</div>
                                        <div class="step-title">ADD DILUTION (OPTIONAL)</div>
                                    </div>
                                    <div class="dilution-options">
                                        <div class="dilution-card ${AppState.dilutionType === 'none' ? 'active' : ''}" onclick="setDilutionType('none', 'classic', ${cocktail.id})">
                                            <div class="dilution-percentage">0%</div>
                                            <div class="dilution-desc">NO DILUTION</div>
                                            <div class="dilution-desc">Best if you plan to shake or stir to order.</div>
                                        </div>
                                        <div class="dilution-card ${AppState.dilutionType === 'spirit-driven' ? 'active' : ''}" onclick="setDilutionType('spirit-driven', 'classic', ${cocktail.id})">
                                            <div class="dilution-percentage">18%</div>
                                            <div class="dilution-desc">SPIRIT-DRIVEN</div>
                                            <div class="dilution-desc">Best for strong drinks containing mainly spirits.</div>
                                        </div>
                                        <div class="dilution-card ${AppState.dilutionType === 'shake' ? 'active' : ''}" onclick="setDilutionType('shake', 'classic', ${cocktail.id})">
                                            <div class="dilution-percentage">25%</div>
                                            <div class="dilution-desc">SHAKEN COCKTAILS</div>
                                            <div class="dilution-desc">Ideal for cocktails with fruit juices, dairy, or eggs.</div>
                                        </div>
                                    </div>
                                    <div class="custom-dilution-group">
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" ${AppState.dilutionType === 'custom' ? 'checked' : ''} onchange="toggleCustomDilutionType(this.checked, 'classic', ${cocktail.id})">
                                            <span>CUSTOM DILUTION</span>
                                        </label>
                                        <input type="number" id="customDilutionInput" 
                                               value="${(AppState.customDilution * 100).toFixed(0)}" 
                                               min="0" max="100" step="1" 
                                               style="width: 80px; padding: 0.5rem; border: 1px solid var(--gray); border-radius: 6px;"
                                               ${AppState.dilutionType !== 'custom' ? 'disabled' : ''}
                                               onchange="setCustomDilution(this.value, 'classic', ${cocktail.id})">
                                        <span>%</span>
                                    </div>
                                </div>

                                <button class="calculate-recipe-btn" onclick="calculateScaledRecipe('classic', ${cocktail.id})">
                                    <i class="fas fa-calculator"></i> CALCULATE SCALED RECIPE
                                </button>

                                ${AppState.showScaledResults ? `
                                    <div class="scaled-results">
                                        <h4 style="color: var(--accent); margin-bottom: 1rem; font-size: 1.1rem;">
                                            Scaled Recipe (${scaleFactor.toFixed(2)}x)
                                        </h4>
                                        
                                        ${dilutionFactor > 0 ? `
                                            <div class="water-note">
                                                <i class="fas fa-tint"></i> Dilution: ${(dilutionFactor * 100).toFixed(0)}%  Water added: ${waterAmount.toFixed(0)}ml
                                            </div>
                                        ` : ''}
                                        
                                        ${AppState.scaleMethod === 'volume' ? `
                                            <div class="serving-note">
                                                <i class="fas fa-users"></i> This batch yields approximately ${servingsFromVolume} servings (based on 150ml per serving)
                                            </div>
                                        ` : ''}
                                        
                                        <table class="recipe-table">
                                            <thead>
                                                <tr>
                                                    <th>Ingredient</th>
                                                    <th>Single</th>
                                                    <th>Batch (ml)</th>
                                                    <th>Unit</th>
                                                    <th>Batch Cost</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${scaledRecipe.map(item => `
                                                    <tr>
                                                        <td>${item.ingredient} ${item.isWater ? '' : ''}</td>
                                                        <td>${item.amount || '-'}</td>
                                                        <td style="font-weight: 700; color: var(--accent);">${item.scaledAmount}</td>
                                                        <td>ml</td>
                                                        <td>$${(item.pourCost * scaleFactor).toFixed(2)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                        
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.5rem;">Total Volume</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${totalVolume.toFixed(0)}ml</div>
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Batch size</div>
                                            </div>
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.5rem;">Batch Cost</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">$${batchCost.toFixed(2)}</div>
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Total ingredients</div>
                                            </div>
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.5rem;">Batch Revenue</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">$${batchRevenue.toFixed(2)}</div>
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Projected sales</div>
                                            </div>
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.5rem;">Final ABV</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${finalAbv.toFixed(1)}%</div>
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">After ${(dilutionFactor * 100).toFixed(0)}% dilution</div>
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                            <button class="btn btn-pdf" onclick="printClassicCocktailSpec(${cocktail.id})" style="flex: 1;">
                                                <i class="fas fa-file-pdf"></i> Print Spec
                                            </button>
                                            <button class="btn btn-share" onclick="shareCocktailSpec(${cocktail.id}, 'classic')" style="flex: 1;">
                                                <i class="fas fa-share-alt"></i> Share Recipe
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Share Cocktail Spec
        function shareCocktailSpec(cocktailId, type, venueId) {
            let cocktail, venue;
            if (type === 'classic') {
                cocktail = AppState.classicCocktails.find(c => c.id === cocktailId);
                venue = { name: 'Classic Cocktails' };
            } else {
                const venueObj = AppState.venues.find(v => v.id === (venueId || AppState.selectedVenue));
                if (venueObj) {
                    cocktail = venueObj.cocktails.find(c => c.id === cocktailId);
                    venue = venueObj;
                }
            }
            
            if (!cocktail) return;
            
            const recipeText = cocktail.recipe.map(item => ` ${item.amount}${item.unit} ${item.ingredient}`).join('\n');
            
            const message = encodeURIComponent(
                `*${cocktail.name}*\n` +
                `${venue.name}  ${cocktail.family || 'Signature'}\n` +
                `\n*Recipe:*\n${recipeText}\n` +
                `\n*Glassware:* ${cocktail.glassware}\n` +
                `*Garnish:* ${cocktail.garnish}\n` +
                `*ABV:* ${cocktail.finalAbv.toFixed(1)}%\n` +
                `*Selling Price:* $${cocktail.sellingPrice}\n` +
                `*COGS:* ${cocktail.cogs}%\n` +
                `\n*Method:*\n${cocktail.method}`
            );
            
            window.open(`https://wa.me/?text=${message}`, '_blank');
            showToast(' Recipe shared via WhatsApp');
        }

        // Set scale method
        function setScaleMethod(method, venueId, cocktailId) {
            AppState.scaleMethod = method;
            AppState.scaleQuantity = method === 'serving' ? 1 : 1000;
            if (venueId === 'classic') {
                renderClassicCocktailDetail(cocktailId);
            } else {
                renderCocktailDetail(venueId, cocktailId);
            }
        }

        // Update scale quantity
        function updateScaleQuantity(value, venueId, cocktailId) {
            AppState.scaleQuantity = parseFloat(value) || 0;
            if (venueId === 'classic') {
                renderClassicCocktailDetail(cocktailId);
            } else {
                renderCocktailDetail(venueId, cocktailId);
            }
        }

        // Toggle custom dilution type
        function toggleCustomDilutionType(checked, venueId, cocktailId) {
            if (checked) {
                AppState.dilutionType = 'custom';
            } else {
                AppState.dilutionType = 'none';
            }
            if (venueId === 'classic') {
                renderClassicCocktailDetail(cocktailId);
            } else {
                renderCocktailDetail(venueId, cocktailId);
            }
        }

        // Calculate scaled recipe
        function calculateScaledRecipe(venueId, cocktailId) {
            AppState.showScaledResults = true;
            if (venueId === 'classic') {
                renderClassicCocktailDetail(cocktailId);
            } else {
                renderCocktailDetail(venueId, cocktailId);
            }
        }

        // Dilution Functions
        function setDilutionType(type, venueId, cocktailId) {
            AppState.dilutionType = type;
            if (venueId === 'classic') {
                renderClassicCocktailDetail(cocktailId);
            } else {
                renderCocktailDetail(venueId, cocktailId);
            }
        }

        function setCustomDilution(value, venueId, cocktailId) {
            AppState.dilutionType = 'custom';
            AppState.customDilution = parseFloat(value) / 100;
            if (venueId === 'classic') {
                renderClassicCocktailDetail(cocktailId);
            } else {
                renderCocktailDetail(venueId, cocktailId);
            }
        }

        // Edit Classic Cocktail
        function editClassicCocktail(cocktailId) {
            const cocktail = AppState.classicCocktails.find(c => c.id === cocktailId);
            
            if (!cocktail) return;
            
            const modal = document.getElementById('addCocktailModal');
            
            document.getElementById('venueSelectionField').style.display = 'none';
            
            setCocktailCategory('classic');
            document.getElementById('cocktailName').value = cocktail.name;
            document.getElementById('cocktailFamily').value = cocktail.family || 'Classic';
            document.getElementById('cocktailCostPrice').value = cocktail.pourCost.toFixed(2);
            document.getElementById('cocktailSellingPrice').value = cocktail.sellingPrice;
            document.getElementById('cocktailGlass').value = cocktail.glassware;
            document.getElementById('cocktailGarnish').value = cocktail.garnish;
            document.getElementById('cocktailMethod').value = cocktail.method || '';
            document.getElementById('cocktailNotes').value = cocktail.notes || '';
            
            const dilutionPreset = cocktail.dilutionPreset || 'none';
            document.querySelectorAll('input[name="dilutionPreset"]').forEach(radio => {
                radio.checked = radio.value === dilutionPreset;
            });
            
            const tbody = document.getElementById('ingredientTableBody');
            tbody.innerHTML = '';
            
            cocktail.recipe.forEach(item => {
                const newRow = document.createElement('tr');
                newRow.className = 'ingredient-row';
                newRow.innerHTML = `
                    <td class="ingredient-search">
                        <input type="text" value="${item.ingredient}" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onkeyup="searchIngredients(this)" autocomplete="off" required>
                        <div class="autocomplete-list" id="autocomplete-${Date.now()}"></div>
                    </td>
                    <td><input type="number" value="${item.bottleSize || 750}" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td><input type="number" value="${item.bottleCost || 0}" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td><input type="number" value="${item.amount}" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td>
                        <select style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="convertUnit(this)">
                            <option value="ml" ${item.unit === 'ml' ? 'selected' : ''}>ml</option>
                            <option value="dash" ${item.unit === 'dash' ? 'selected' : ''}>dash</option>
                        </select>
                    </td>
                    <td><input type="number" value="${item.pourCost || 0}" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="pour-cost"></td>
                    <td><input type="number" value="${item.abv || 40}" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientABV(this)" required></td>
                    <td><button type="button" onclick="removeIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(newRow);
                
                if (item.spiritId) {
                    newRow.dataset.spiritId = item.spiritId;
                }
                
                const bottleSize = item.bottleSize || 750;
                const bottleCost = item.bottleCost || 0;
                const pour = item.unit === 'dash' ? item.amount * DASH_TO_ML : item.amount;
                const pourCost = bottleSize > 0 ? (pour / bottleSize) * bottleCost : 0;
                const pourCostInput = newRow.cells[5].querySelector('input');
                pourCostInput.value = pourCost.toFixed(3);
            });
            
            addIngredientRow();
            
            const form = document.getElementById('newCocktailForm');
            form.onsubmit = (e) => updateClassicCocktail(e, cocktailId);
            
            modal.style.display = 'flex';
            
            calculateFinalABV();
            calculateTotalPourCost();
        }

        // Update Classic Cocktail
        function updateClassicCocktail(event, cocktailId) {
            event.preventDefault();
            
            const cocktail = AppState.classicCocktails.find(c => c.id === cocktailId);
            
            if (!cocktail) return;
            
            let dilutionPreset = 'none';
            let customDilution = null;
            
            const selectedDilution = document.querySelector('input[name="dilutionPreset"]:checked');
            if (selectedDilution) {
                dilutionPreset = selectedDilution.value;
            }
            
            const useCustom = document.getElementById('useCustomDilution');
            if (useCustom && useCustom.checked) {
                const customValue = document.getElementById('customDilutionValue');
                if (customValue && customValue.value) {
                    customDilution = parseFloat(customValue.value) / 100;
                }
            }
            
            const rows = document.querySelectorAll('.ingredient-row');
            const recipe = [];
            let totalPourCost = 0;
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const unitSelect = row.querySelector('select');
                if (inputs[0].value && inputs[1].value && inputs[3].value) {
                    const spiritId = row.dataset.spiritId || null;
                    const unit = unitSelect ? unitSelect.value : 'ml';
                    let pourAmount = parseFloat(inputs[3].value);
                    
                    // Convert to ml for calculation
                    if (unit === 'dash') {
                        pourAmount = pourAmount * DASH_TO_ML;
                    }
                    
                    const pourCost = (pourAmount / parseFloat(inputs[1].value)) * parseFloat(inputs[2].value);
                    totalPourCost += pourCost;
                    
                    recipe.push({
                        ingredient: inputs[0].value,
                        bottleSize: parseFloat(inputs[1].value),
                        bottleCost: parseFloat(inputs[2].value),
                        amount: parseFloat(inputs[3].value),
                        unit: unit,
                        pourCost: pourCost,
                        abv: parseFloat(inputs[6].value) || 0,
                        spiritId: spiritId
                    });
                }
            });
            
            const sellingPrice = parseFloat(document.getElementById('cocktailSellingPrice').value);
            const cogs = (totalPourCost / sellingPrice * 100);
            
            const totalAlcohol = recipe.reduce((acc, item) => {
                let amount = item.amount;
                if (item.unit === 'dash') {
                    amount = amount * DASH_TO_ML;
                }
                return acc + (amount * (item.abv / 100));
            }, 0);
            
            const totalVolume = recipe.reduce((acc, item) => {
                let amount = item.amount;
                if (item.unit === 'dash') {
                    amount = amount * DASH_TO_ML;
                }
                return acc + amount;
            }, 0);
            
            const dilutionFactor = customDilution || AppState.dilutionPresets[dilutionPreset] || 0;
            const finalAbv = totalVolume > 0 ? (totalAlcohol / totalVolume) / (1 + dilutionFactor) * 100 : 0;
            
            cocktail.name = document.getElementById('cocktailName').value;
            cocktail.family = document.getElementById('cocktailFamily').value;
            cocktail.recipe = recipe;
            cocktail.pourCost = totalPourCost;
            cocktail.sellingPrice = sellingPrice;
            cocktail.cogs = parseFloat(cogs.toFixed(1));
            cocktail.finalAbv = parseFloat(finalAbv.toFixed(1));
            cocktail.method = document.getElementById('cocktailMethod').value;
            cocktail.garnish = document.getElementById('cocktailGarnish').value;
            cocktail.glassware = document.getElementById('cocktailGlass').value;
            cocktail.notes = document.getElementById('cocktailNotes').value;
            cocktail.dilutionPreset = dilutionPreset;
            cocktail.customDilution = customDilution;
            
            closeModal('addCocktailModal');
            
            const form = document.getElementById('newCocktailForm');
            form.onsubmit = saveNewCocktail;
            document.getElementById('venueSelectionField').style.display = 'block';
            
            renderClassicCocktailDetail(cocktailId);
            showToast(` ${cocktail.name} updated successfully`);
        }

        // Print Classic Cocktail Spec
        function printClassicCocktailSpec(cocktailId) {
            AppState.selectedCocktailsForPrint = [cocktailId];
            printClassicCocktailSpecs();
            AppState.selectedCocktailsForPrint = [];
        }

        // Print Classic Cocktail Specs
        async function printClassicCocktailSpecs() {
            if (AppState.selectedCocktailsForPrint.length === 0) {
                showToast(' Please select a cocktail to print');
                return;
            }

            const selectedCocktails = AppState.classicCocktails.filter(c => AppState.selectedCocktailsForPrint.includes(c.id));
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            let yOffset = 20;
            const pageHeight = pdf.internal.pageSize.height;
            const margin = 20;

            pdf.setFillColor(0, 0, 0);
            pdf.circle(30, yOffset, 8, 'F');
            pdf.setTextColor(230, 126, 34);
            pdf.setFontSize(24);
            pdf.setFont('helvetica', 'bold');
            pdf.text(' BLACK SHEEP', 45, yOffset + 5);
            pdf.setTextColor(44, 62, 80);
            pdf.setFontSize(16);
            pdf.text('CLASSIC COCKTAIL SPEC', 45, yOffset + 15);
            
            yOffset += 25;
            
            pdf.setDrawColor(230, 126, 34);
            pdf.setLineWidth(0.5);
            pdf.line(margin, yOffset, pdf.internal.pageSize.width - margin, yOffset);
            
            yOffset += 15;

            for (let i = 0; i < selectedCocktails.length; i++) {
                const cocktail = selectedCocktails[i];
                
                if (yOffset > pageHeight - 40) {
                    pdf.addPage();
                    yOffset = 20;
                }

                pdf.setTextColor(230, 126, 34);
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.text(cocktail.name, margin, yOffset);
                
                yOffset += 8;
                
                pdf.setTextColor(149, 165, 166);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`${cocktail.family}`, margin, yOffset);
                
                yOffset += 12;

                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('RECIPE', margin, yOffset);
                
                yOffset += 6;
                
                cocktail.recipe.forEach((item) => {
                    pdf.setTextColor(52, 73, 94);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(` ${item.amount}${item.unit} ${item.ingredient}`, margin + 5, yOffset);
                    yOffset += 5;
                });
                
                yOffset += 5;

                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'bold');
                pdf.text('GLASSWARE:', margin, yOffset);
                pdf.setTextColor(52, 73, 94);
                pdf.setFont('helvetica', 'normal');
                pdf.text(` ${cocktail.glassware}`, margin + 35, yOffset);
                
                yOffset += 6;
                
                pdf.setTextColor(44, 62, 80);
                pdf.setFont('helvetica', 'bold');
                pdf.text('GARNISH:', margin, yOffset);
                pdf.setTextColor(52, 73, 94);
                pdf.setFont('helvetica', 'normal');
                pdf.text(` ${cocktail.garnish}`, margin + 35, yOffset);
                
                yOffset += 8;

                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('METHOD', margin, yOffset);
                
                yOffset += 6;
                
                const methodLines = pdf.splitTextToSize(cocktail.method, pdf.internal.pageSize.width - 40);
                pdf.setTextColor(52, 73, 94);
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.text(methodLines, margin + 5, yOffset);
                
                yOffset += methodLines.length * 5 + 10;

                if (i < selectedCocktails.length - 1) {
                    pdf.setDrawColor(230, 126, 34);
                    pdf.setLineWidth(0.2);
                    pdf.setLineDash([2, 2]);
                    pdf.line(margin, yOffset, pdf.internal.pageSize.width - margin, yOffset);
                    pdf.setLineDash([]);
                    yOffset += 15;
                }
            }

            pdf.save('Classic_Cocktail_Specs.pdf');
            showToast(` PDF generated for ${selectedCocktails.length} classic cocktails`);
        }

        // Open Add Classic Cocktail Modal
        function openAddClassicCocktailModal() {
            openAddCocktailModal();
            setCocktailCategory('classic');
            document.getElementById('venueSelectionField').style.display = 'none';
        }

        // Update Cocktail Selling Price from Overview - Auto-update COGS
        function updateCocktailSellingPrice(venueId, cocktailId, newPrice) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktail = venue.cocktails.find(c => c.id === cocktailId);
            
            if (cocktail) {
                cocktail.sellingPrice = parseFloat(newPrice);
                cocktail.cogs = ((cocktail.pourCost / cocktail.sellingPrice) * 100).toFixed(1);
                showToast(` ${cocktail.name} price updated - COGS: ${cocktail.cogs}%`);
                
                const cogsCell = event.target.closest('tr').querySelector('td:last-child');
                if (cogsCell) {
                    cogsCell.style.color = cocktail.cogs < 25 ? 'var(--profit)' : cocktail.cogs < 35 ? 'var(--warning)' : 'var(--loss)';
                    cogsCell.textContent = `${cocktail.cogs}%`;
                }
            }
        }

        // Upload Venue Image
        function uploadVenueImage(venueId, event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const venue = AppState.venues.find(v => v.id === venueId);
                    if (venue) {
                        venue.image = e.target.result;
                        renderVenuesGrid();
                        showToast(` ${venue.name} image updated`);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // Edit Venue
        function editVenue(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            if (!venue) return;
            
            document.getElementById('editVenueId').value = venue.id;
            document.getElementById('editVenueName').value = venue.name;
            document.getElementById('editVenueLocation').value = venue.location;
            
            document.getElementById('editVenueModal').style.display = 'flex';
        }

        // Save Venue Changes
        function saveVenueChanges(event) {
            event.preventDefault();
            
            const venueId = parseInt(document.getElementById('editVenueId').value);
            const venue = AppState.venues.find(v => v.id === venueId);
            
            if (venue) {
                venue.name = document.getElementById('editVenueName').value;
                venue.location = document.getElementById('editVenueLocation').value;
                
                closeModal('editVenueModal');
                renderVenuesGrid();
                showToast(` Venue updated successfully`);
            }
        }

        // Delete Venue
        function deleteVenue(venueId) {
            if (confirm('Are you sure you want to delete this venue? All cocktails will be lost.')) {
                const index = AppState.venues.findIndex(v => v.id === venueId);
                if (index !== -1) {
                    AppState.venues.splice(index, 1);
                    renderVenuesGrid();
                    showToast(` Venue deleted`);
                }
            }
        }

        // Venue Navigation Functions
        function selectVenue(venueId) {
            AppState.currentView = 'cocktails';
            AppState.selectedVenue = venueId;
            renderCocktailList(venueId);
        }

        function viewCocktailOverview(venueId) {
            AppState.currentView = 'overview';
            AppState.selectedVenue = venueId;
            renderCocktailOverview(venueId);
        }

        function goBackToVenues() {
            AppState.currentView = 'venues';
            AppState.selectedVenue = null;
            AppState.selectedCocktail = null;
            renderVenuesGrid();
        }

        function goBackToCocktails(venueId) {
            AppState.currentView = 'cocktails';
            AppState.selectedVenue = venueId;
            AppState.selectedCocktail = null;
            renderCocktailList(venueId);
        }

        // Update venue order after drag & drop
        function updateVenueOrder() {
            const venueCards = document.querySelectorAll('.venue-card');
            venueCards.forEach((card, index) => {
                const venueId = parseInt(card.dataset.id);
                const venue = AppState.venues.find(v => v.id === venueId);
                if (venue) {
                    venue.order = index + 1;
                }
            });
            
            AppState.venues.sort((a, b) => a.order - b.order);
            showToast('Venue order updated');
        }

        // Cocktail List with Drag & Drop
        function renderCocktailList(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const sortedCocktails = [...venue.cocktails].sort((a, b) => (a.order || 0) - (b.order || 0));
            
            mainContent.innerHTML = `
                <div class="top-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="back-button" onclick="goBackToVenues()">
                            <i class="fas fa-arrow-left"></i> Back to Venues
                        </button>
                        <h1 class="page-title" style="margin-left: 1rem;">
                            <i class="fas fa-cocktail"></i>
                            ${venue.name}
                        </h1>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-outline" onclick="viewCocktailOverview(${venue.id})">
                            <i class="fas fa-list"></i> Menu Overview
                        </button>
                        <button class="btn btn-primary" onclick="openAddCocktailModalForVenue(${venue.id})">
                            <i class="fas fa-plus"></i> New Cocktail
                        </button>
                    </div>
                </div>

                <div class="cocktail-list" id="cocktailList">
                    ${sortedCocktails.map(cocktail => `
                        <div class="cocktail-item" data-id="${cocktail.id}" data-order="${cocktail.order || 0}">
                            <div class="cocktail-drag-handle">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                            <div class="cocktail-thumbnail" onclick="viewCocktailDetail(${venue.id}, ${cocktail.id})">
                                <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=100'}" alt="${cocktail.name}">
                            </div>
                            <div class="cocktail-info" onclick="viewCocktailDetail(${venue.id}, ${cocktail.id})">
                                <div class="cocktail-name">
                                    ${cocktail.name}
                                    <span style="margin-left: 0.5rem; background: rgba(230,126,34,0.1); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem;">
                                        ${cocktail.family || 'Signature'}
                                    </span>
                                    <button class="favorite-btn ${cocktail.favorite ? 'active' : ''}" 
                                            onclick="toggleFavorite(${venue.id}, ${cocktail.id}, event)"
                                            style="background: none; border: none; color: ${cocktail.favorite ? 'var(--warning)' : 'var(--gray)'}; margin-left: 0.5rem;">
                                        <i class="fa${cocktail.favorite ? 's' : 'r'} fa-star"></i>
                                    </button>
                                </div>
                                <div class="cocktail-meta">
                                    <span><i class="fas fa-wine-glass"></i> ${cocktail.glassware}</span>
                                    <span><i class="fas fa-leaf"></i> ${cocktail.garnish}</span>
                                    <span><i class="fas fa-percent"></i> ${cocktail.finalAbv.toFixed(1)}% ABV</span>
                                    <span class="cogs-badge ${cocktail.cogs < 25 ? 'cogs-good' : cocktail.cogs < 35 ? 'cogs-warning' : 'cogs-high'}">
                                        COGS: ${cocktail.cogs}%
                                    </span>
                                    <button class="edit-btn" onclick="event.stopPropagation(); editCocktail(${venue.id}, ${cocktail.id})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="share-btn" onclick="event.stopPropagation(); shareCocktailSpec(${cocktail.id}, 'signature', ${venue.id})">
                                        <i class="fas fa-share-alt"></i> Share
                                    </button>
                                </div>
                                <div style="margin-top: 0.5rem; color: var(--gray); font-size: 0.875rem;">
                                    ${cocktail.recipe.length} ingredients  $${cocktail.sellingPrice}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            setTimeout(() => {
                const cocktailList = document.getElementById('cocktailList');
                if (cocktailList) {
                    new Sortable(cocktailList, {
                        animation: 150,
                        handle: '.cocktail-drag-handle',
                        onEnd: function(evt) {
                            updateCocktailOrder(venueId);
                        }
                    });
                }
            }, 100);
        }

        // Update cocktail order after drag & drop
        function updateCocktailOrder(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktailItems = document.querySelectorAll('.cocktail-item');
            
            cocktailItems.forEach((item, index) => {
                const cocktailId = parseInt(item.dataset.id);
                const cocktail = venue.cocktails.find(c => c.id === cocktailId);
                if (cocktail) {
                    cocktail.order = index + 1;
                }
            });
            
            venue.cocktails.sort((a, b) => (a.order || 0) - (b.order || 0));
            showToast('Cocktail order updated');
        }

        // Cocktail Detail Page
        function viewCocktailDetail(venueId, cocktailId) {
            AppState.currentView = 'detail';
            AppState.selectedVenue = venueId;
            AppState.selectedCocktail = cocktailId;
            AppState.scaleMethod = 'serving';
            AppState.scaleQuantity = 1;
            AppState.dilutionType = 'none';
            AppState.customDilution = 0.20;
            AppState.showScaledResults = false;
            AppState.omittedIngredients = [];
            
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktail = venue.cocktails.find(c => c.id === cocktailId);
            if (cocktail && cocktail.dilutionPreset) {
                AppState.dilutionType = cocktail.dilutionPreset;
            }
            
            renderCocktailDetail(venueId, cocktailId);
        }

        // Cocktail Detail Page
        function renderCocktailDetail(venueId, cocktailId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktail = venue.cocktails.find(c => c.id === cocktailId);
            
            if (!cocktail) return;

            let dilutionFactor = AppState.dilutionPresets[AppState.dilutionType] || 0;
            if (AppState.dilutionType === 'custom') {
                dilutionFactor = AppState.customDilution;
            }

            const activeRecipe = cocktail.recipe.filter((item, index) => 
                !AppState.omittedIngredients.includes(`${cocktailId}-${index}`)
            );

            const totalPreDilutionVolume = activeRecipe.reduce((acc, item) => {
                if (item.unit === 'ml') return acc + item.amount;
                if (item.unit === 'dash') return acc + (item.amount * DASH_TO_ML);
                if (item.unit === 'oz') return acc + (item.amount * 29.5735);
                return acc;
            }, 0);

            const scaleFactor = AppState.scaleMethod === 'serving' 
                ? AppState.scaleQuantity / (cocktail.batchSize || 1)
                : AppState.scaleQuantity / totalPreDilutionVolume;
            
            const waterAmount = AppState.showScaledResults && dilutionFactor > 0 ? totalPreDilutionVolume * dilutionFactor * scaleFactor : 0;
            
            let scaledRecipe = [];
            let totalVolume = 0;
            let batchCost = 0;
            let batchRevenue = 0;
            let finalAbv = 0;
            let servingsFromVolume = 0;
            
            if (AppState.showScaledResults) {
                scaledRecipe = activeRecipe.map(item => ({
                    ...item,
                    scaledAmount: (item.amount * scaleFactor).toFixed(1)
                }));

                if (AppState.includeWater && waterAmount > 0) {
                    scaledRecipe.push({
                        ingredient: "Water (dilution)",
                        amount: 0,
                        scaledAmount: waterAmount.toFixed(1),
                        unit: "ml",
                        pourCost: 0,
                        abv: 0,
                        isWater: true
                    });
                }

                totalVolume = scaledRecipe.reduce((acc, item) => acc + parseFloat(item.scaledAmount), 0);
                batchCost = activeRecipe.reduce((acc, item) => acc + (item.pourCost * scaleFactor), 0);
                batchRevenue = (cocktail.sellingPrice * (AppState.scaleMethod === 'serving' ? AppState.scaleQuantity : totalVolume / 150));
                servingsFromVolume = Math.round(totalVolume / 150);
                
                const totalAlcohol = activeRecipe.reduce((acc, item) => {
                    let amount = item.amount;
                    if (item.unit === 'dash') {
                        amount = amount * DASH_TO_ML;
                    }
                    return acc + (amount * (item.abv / 100));
                }, 0);
                
                finalAbv = totalPreDilutionVolume > 0 
                    ? (totalAlcohol / totalPreDilutionVolume) / (1 + dilutionFactor) * 100 
                    : 0;
            }

            mainContent.innerHTML = `
                <div class="top-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="back-button" onclick="goBackToCocktails(${venueId})">
                            <i class="fas fa-arrow-left"></i> Back to ${venue.name}
                        </button>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="editCocktail(${venueId}, ${cocktailId})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-pdf" onclick="printSingleCocktailSpec(${venueId}, ${cocktailId})">
                            <i class="fas fa-file-pdf"></i> Print Spec
                        </button>
                        <button class="btn btn-share" onclick="shareCocktailSpec(${cocktailId}, 'signature', ${venueId})">
                            <i class="fas fa-share-alt"></i> Share
                        </button>
                        <button class="favorite-btn ${cocktail.favorite ? 'active' : ''}" 
                                onclick="toggleFavorite(${venue.id}, ${cocktail.id}, event)"
                                style="background: none; border: 1px solid ${cocktail.favorite ? 'var(--warning)' : 'var(--gray)'}; padding: 0.75rem 1.5rem; border-radius: 10px; color: ${cocktail.favorite ? 'var(--warning)' : 'var(--gray)'};">
                            <i class="fa${cocktail.favorite ? 's' : 'r'} fa-star"></i> Favorite
                        </button>
                    </div>
                </div>

                <div class="cocktail-detail">
                    <div class="cocktail-silhouette">
                        <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400'}" alt="silhouette">
                    </div>

                    <div class="detail-content">
                        <div class="detail-header">
                            <div class="detail-image">
                                <img src="${cocktail.image || 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400'}" alt="${cocktail.name}" id="cocktailDetailImage">
                                <div class="image-upload-btn">
                                    <input type="file" accept="image/*" onchange="uploadCocktailImage(${venueId}, ${cocktailId}, event)" style="display: none;" id="imageUpload">
                                    <button class="btn btn-outline" style="padding: 0.5rem;" onclick="document.getElementById('imageUpload').click()">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="detail-title">
                                <div class="detail-name">${cocktail.name}</div>
                                <div class="detail-venue">
                                    <i class="fas fa-store"></i> ${venue.name}
                                    <span style="margin-left: 1rem; background: rgba(230,126,34,0.1); padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.875rem;">
                                        ${cocktail.family || 'Signature'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="info-item">
                                <span class="info-item-label">Glassware</span>
                                <span class="info-item-value">${cocktail.glassware}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Garnish</span>
                                <span class="info-item-value">${cocktail.garnish}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Final ABV</span>
                                <span class="info-item-value">${cocktail.finalAbv.toFixed(1)}%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Added</span>
                                <span class="info-item-value">${cocktail.dateAdded || '2024-01-15'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">Author</span>
                                <span class="info-item-value">${cocktail.author || 'Bar Manager'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label selling-price">Selling Price</span>
                                <span class="info-item-value selling-price">$${cocktail.sellingPrice}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-item-label">COGS</span>
                                <span class="info-item-value cogs-display ${cocktail.cogs < 25 ? 'cogs-good' : cocktail.cogs < 35 ? 'cogs-warning' : 'cogs-high'}">
                                    ${cocktail.cogs}%
                                </span>
                            </div>
                        </div>

                        <div class="recipe-section">
                            <div class="section-title">
                                <i class="fas fa-flask"></i> Recipe
                            </div>

                            <table class="recipe-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">Omit</th>
                                        <th>Ingredient</th>
                                        <th>Amount</th>
                                        <th>Unit</th>
                                        <th>Pour Cost</th>
                                        <th>ABV</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${cocktail.recipe.map((item, index) => {
                                        const isOmitted = AppState.omittedIngredients.includes(`${cocktailId}-${index}`);
                                        return `
                                            <tr style="${isOmitted ? 'opacity: 0.5; text-decoration: line-through;' : ''}">
                                                <td>
                                                    <input type="checkbox" class="omit-checkbox" 
                                                           ${isOmitted ? 'checked' : ''}
                                                           onchange="toggleOmitIngredient(${venueId}, ${cocktailId}, ${index}, this.checked)">
                                                </td>
                                                <td>
                                                    <span class="ingredient-reference" onclick="showIngredientReference('${item.spiritId || ''}', '${item.ingredient}')">
                                                        ${item.ingredient}
                                                    </span>
                                                </td>
                                                <td>${item.amount}</td>
                                                <td>${item.unit}</td>
                                                <td>$${item.pourCost ? item.pourCost.toFixed(2) : '0.00'}</td>
                                                <td>${item.abv}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>

                            <div class="method-section">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <i class="fas fa-flask" style="color: var(--accent);"></i>
                                    <span style="font-weight: 600; color: var(--primary);">Method</span>
                                </div>
                                <p style="color: var(--dark); line-height: 1.6;">${cocktail.method}</p>
                            </div>

                            ${cocktail.notes ? `
                                <div class="notes-section">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                        <i class="fas fa-sticky-note" style="color: var(--accent);"></i>
                                        <span style="font-weight: 600; color: var(--primary);">Notes</span>
                                    </div>
                                    <p style="color: var(--dark); line-height: 1.6;">${cocktail.notes}</p>
                                </div>
                            ` : ''}

                            <div class="scale-recipe-section">
                                <div class="scale-title">
                                    <i class="fas fa-calculator"></i> SCALE RECIPE
                                </div>

                                <div class="scale-step">
                                    <div class="step-header">
                                        <div class="step-number">1</div>
                                        <div class="step-title">CHOOSE SCALING METHOD</div>
                                    </div>
                                    <div class="scale-options">
                                        <div class="scale-option ${AppState.scaleMethod === 'serving' ? 'active' : ''}" onclick="setScaleMethod('serving', ${venueId}, ${cocktailId})">
                                            <div class="scale-option-title">SCALE BY NUMBER OF SERVINGS</div>
                                            <div class="scale-option-desc">Choose this if you know how many servings you need.</div>
                                        </div>
                                        <div class="scale-option ${AppState.scaleMethod === 'volume' ? 'active' : ''}" onclick="setScaleMethod('volume', ${venueId}, ${cocktailId})">
                                            <div class="scale-option-title">SCALE BY TOTAL VOLUME (ML)</div>
                                            <div class="scale-option-desc">Ideal for filling a specific container or batch size.</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="scale-step">
                                    <div class="step-header">
                                        <div class="step-number">2</div>
                                        <div class="step-title">ENTER QUANTITY</div>
                                    </div>
                                    <div class="quantity-input-group">
                                        <input type="number" id="scaleQuantityInput" class="quantity-input" 
                                               value="${AppState.scaleQuantity}" min="0.1" step="0.1" 
                                               onchange="updateScaleQuantity(this.value, ${venueId}, ${cocktailId})">
                                        <span class="quantity-label">${AppState.scaleMethod === 'serving' ? 'SERVINGS' : 'MILLILITERS (ML)'}</span>
                                    </div>
                                </div>

                                <div class="scale-step">
                                    <div class="step-header">
                                        <div class="step-number">3</div>
                                        <div class="step-title">ADD DILUTION (OPTIONAL)</div>
                                    </div>
                                    <div class="dilution-options">
                                        <div class="dilution-card ${AppState.dilutionType === 'none' ? 'active' : ''}" onclick="setDilutionType('none', ${venueId}, ${cocktailId})">
                                            <div class="dilution-percentage">0%</div>
                                            <div class="dilution-desc">NO DILUTION</div>
                                            <div class="dilution-desc">Best if you plan to shake or stir to order.</div>
                                        </div>
                                        <div class="dilution-card ${AppState.dilutionType === 'spirit-driven' ? 'active' : ''}" onclick="setDilutionType('spirit-driven', ${venueId}, ${cocktailId})">
                                            <div class="dilution-percentage">18%</div>
                                            <div class="dilution-desc">SPIRIT-DRIVEN</div>
                                            <div class="dilution-desc">Best for strong drinks containing mainly spirits.</div>
                                        </div>
                                        <div class="dilution-card ${AppState.dilutionType === 'shake' ? 'active' : ''}" onclick="setDilutionType('shake', ${venueId}, ${cocktailId})">
                                            <div class="dilution-percentage">25%</div>
                                            <div class="dilution-desc">SHAKEN COCKTAILS</div>
                                            <div class="dilution-desc">Ideal for cocktails with fruit juices, dairy, or eggs.</div>
                                        </div>
                                    </div>
                                    <div class="custom-dilution-group">
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" ${AppState.dilutionType === 'custom' ? 'checked' : ''} onchange="toggleCustomDilutionType(this.checked, ${venueId}, ${cocktailId})">
                                            <span>CUSTOM DILUTION</span>
                                        </label>
                                        <input type="number" id="customDilutionInput" 
                                               value="${(AppState.customDilution * 100).toFixed(0)}" 
                                               min="0" max="100" step="1" 
                                               style="width: 80px; padding: 0.5rem; border: 1px solid var(--gray); border-radius: 6px;"
                                               ${AppState.dilutionType !== 'custom' ? 'disabled' : ''}
                                               onchange="setCustomDilution(this.value, ${venueId}, ${cocktailId})">
                                        <span>%</span>
                                    </div>
                                </div>

                                <button class="calculate-recipe-btn" onclick="calculateScaledRecipe(${venueId}, ${cocktailId})">
                                    <i class="fas fa-calculator"></i> CALCULATE SCALED RECIPE
                                </button>

                                ${AppState.showScaledResults ? `
                                    <div class="scaled-results">
                                        <h4 style="color: var(--accent); margin-bottom: 1rem; font-size: 1.1rem;">
                                            Scaled Recipe (${scaleFactor.toFixed(2)}x)
                                        </h4>
                                        
                                        ${dilutionFactor > 0 ? `
                                            <div class="water-note">
                                                <i class="fas fa-tint"></i> Dilution: ${(dilutionFactor * 100).toFixed(0)}%  Water added: ${waterAmount.toFixed(0)}ml
                                            </div>
                                        ` : ''}
                                        
                                        ${AppState.scaleMethod === 'volume' ? `
                                            <div class="serving-note">
                                                <i class="fas fa-users"></i> This batch yields approximately ${servingsFromVolume} servings (based on 150ml per serving)
                                            </div>
                                        ` : ''}
                                        
                                        <table class="recipe-table">
                                            <thead>
                                                <tr>
                                                    <th>Ingredient</th>
                                                    <th>Single</th>
                                                    <th>Batch (ml)</th>
                                                    <th>Unit</th>
                                                    <th>Batch Cost</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${scaledRecipe.map(item => `
                                                    <tr>
                                                        <td>${item.ingredient} ${item.isWater ? '' : ''}</td>
                                                        <td>${item.amount || '-'}</td>
                                                        <td style="font-weight: 700; color: var(--accent);">${item.scaledAmount}</td>
                                                        <td>ml</td>
                                                        <td>$${(item.pourCost * scaleFactor).toFixed(2)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                        
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.5rem;">Total Volume</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${totalVolume.toFixed(0)}ml</div>
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Batch size</div>
                                            </div>
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.5rem;">Batch Cost</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">$${batchCost.toFixed(2)}</div>
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Total ingredients</div>
                                            </div>
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.5rem;">Batch Revenue</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">$${batchRevenue.toFixed(2)}</div>
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Projected sales</div>
                                            </div>
                                            <div style="background: var(--white); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 0.5rem;">Final ABV</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${finalAbv.toFixed(1)}%</div>
                                                <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">After ${(dilutionFactor * 100).toFixed(0)}% dilution</div>
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                            <button class="btn btn-pdf" onclick="printSingleCocktailSpec(${venueId}, ${cocktailId})" style="flex: 1;">
                                                <i class="fas fa-file-pdf"></i> Print Spec
                                            </button>
                                            <button class="btn btn-share" onclick="shareCocktailSpec(${cocktailId}, 'signature', ${venueId})" style="flex: 1;">
                                                <i class="fas fa-share-alt"></i> Share Recipe
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Toggle omit ingredient
        function toggleOmitIngredient(venueId, cocktailId, ingredientIndex, isOmitted) {
            const key = `${cocktailId}-${ingredientIndex}`;
            if (isOmitted) {
                if (!AppState.omittedIngredients.includes(key)) {
                    AppState.omittedIngredients.push(key);
                }
            } else {
                AppState.omittedIngredients = AppState.omittedIngredients.filter(k => k !== key);
            }
            renderCocktailDetail(venueId, cocktailId);
        }

        // Print Single Cocktail Spec
        function printSingleCocktailSpec(venueId, cocktailId) {
            AppState.selectedCocktailsForPrint = [cocktailId];
            printSelectedCocktailSpecs(venueId);
            AppState.selectedCocktailsForPrint = [];
        }

        // Print Selected Cocktail Specs
        async function printSelectedCocktailSpecs(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            
            if (AppState.selectedCocktailsForPrint.length === 0) {
                showToast(' Please select at least one cocktail to print');
                return;
            }

            const selectedCocktails = venue.cocktails.filter(c => AppState.selectedCocktailsForPrint.includes(c.id));
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            let yOffset = 20;
            const pageHeight = pdf.internal.pageSize.height;
            const margin = 20;

            pdf.setFillColor(0, 0, 0);
            pdf.circle(30, yOffset, 8, 'F');
            pdf.setTextColor(230, 126, 34);
            pdf.setFontSize(24);
            pdf.setFont('helvetica', 'bold');
            pdf.text(' BLACK SHEEP', 45, yOffset + 5);
            pdf.setTextColor(44, 62, 80);
            pdf.setFontSize(16);
            pdf.text('COCKTAIL SPEC', 45, yOffset + 15);
            
            yOffset += 25;
            
            pdf.setDrawColor(230, 126, 34);
            pdf.setLineWidth(0.5);
            pdf.line(margin, yOffset, pdf.internal.pageSize.width - margin, yOffset);
            
            yOffset += 15;

            for (let i = 0; i < selectedCocktails.length; i++) {
                const cocktail = selectedCocktails[i];
                
                if (yOffset > pageHeight - 40) {
                    pdf.addPage();
                    yOffset = 20;
                }

                pdf.setTextColor(230, 126, 34);
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.text(cocktail.name, margin, yOffset);
                
                yOffset += 8;
                
                pdf.setTextColor(149, 165, 166);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`${venue.name}  ${cocktail.family || 'Signature'}`, margin, yOffset);
                
                yOffset += 12;

                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('RECIPE', margin, yOffset);
                
                yOffset += 6;
                
                cocktail.recipe.forEach((item) => {
                    pdf.setTextColor(52, 73, 94);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(` ${item.amount}${item.unit} ${item.ingredient}`, margin + 5, yOffset);
                    yOffset += 5;
                });
                
                yOffset += 5;

                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'bold');
                pdf.text('GLASSWARE:', margin, yOffset);
                pdf.setTextColor(52, 73, 94);
                pdf.setFont('helvetica', 'normal');
                pdf.text(` ${cocktail.glassware}`, margin + 35, yOffset);
                
                yOffset += 6;
                
                pdf.setTextColor(44, 62, 80);
                pdf.setFont('helvetica', 'bold');
                pdf.text('GARNISH:', margin, yOffset);
                pdf.setTextColor(52, 73, 94);
                pdf.setFont('helvetica', 'normal');
                pdf.text(` ${cocktail.garnish}`, margin + 35, yOffset);
                
                yOffset += 8;

                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('METHOD', margin, yOffset);
                
                yOffset += 6;
                
                const methodLines = pdf.splitTextToSize(cocktail.method, pdf.internal.pageSize.width - 40);
                pdf.setTextColor(52, 73, 94);
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.text(methodLines, margin + 5, yOffset);
                
                yOffset += methodLines.length * 5 + 10;

                if (i < selectedCocktails.length - 1) {
                    pdf.setDrawColor(230, 126, 34);
                    pdf.setLineWidth(0.2);
                    pdf.setLineDash([2, 2]);
                    pdf.line(margin, yOffset, pdf.internal.pageSize.width - margin, yOffset);
                    pdf.setLineDash([]);
                    yOffset += 15;
                }
            }

            pdf.save(`${venue.name}_Cocktail_Specs.pdf`);
            showToast(` PDF generated for ${selectedCocktails.length} cocktails`);
            
            clearCocktailSelection(venueId);
        }

        // Cocktail Selection for Printing
        function toggleCocktailForPrint(venueId, cocktailId, isSelected) {
            if (isSelected) {
                if (!AppState.selectedCocktailsForPrint.includes(cocktailId)) {
                    AppState.selectedCocktailsForPrint.push(cocktailId);
                }
            } else {
                AppState.selectedCocktailsForPrint = AppState.selectedCocktailsForPrint.filter(id => id !== cocktailId);
            }
            updateSelectedCount();
        }

        function selectAllCocktailsForPrint(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            AppState.selectedCocktailsForPrint = venue.cocktails.map(c => c.id);
            
            const checkboxes = document.querySelectorAll('.cocktail-select-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            
            updateSelectedCount();
            showToast(` Selected ${AppState.selectedCocktailsForPrint.length} cocktails`);
        }

        function clearCocktailSelection(venueId) {
            AppState.selectedCocktailsForPrint = [];
            
            const checkboxes = document.querySelectorAll('.cocktail-select-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            
            updateSelectedCount();
            showToast('Selection cleared');
        }

        function updateSelectedCount() {
            const countEl = document.getElementById('selectedCount');
            if (countEl) {
                countEl.textContent = AppState.selectedCocktailsForPrint.length;
            }
        }

        // Ingredient Reference
        function showIngredientReference(spiritId, ingredientName) {
            if (!spiritId) {
                showToast('No spirit library reference for this ingredient');
                return;
            }
            
            const spirit = AppState.spiritLibrary.find(s => s.id === spiritId);
            if (!spirit) {
                showToast('Spirit not found in library');
                return;
            }
            
            const modal = document.getElementById('componentReferenceModal');
            const content = document.getElementById('componentDetailContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="color: var(--accent); margin-bottom: 0.5rem;">${spirit.name}</h3>
                    <p style="color: var(--gray);">${spirit.type}  ${spirit.brand}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: var(--light); padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--gray);">ABV</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">${spirit.abv}%</div>
                    </div>
                    <div style="background: var(--light); padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--gray);">Bottle Size</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">${spirit.bottleSize}ml</div>
                    </div>
                    <div style="background: var(--light); padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--gray);">Bottle Cost</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">$${spirit.bottleCost.toFixed(2)}</div>
                    </div>
                    <div style="background: var(--light); padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--gray);">Cost per ml</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">$${(spirit.bottleCost / spirit.bottleSize).toFixed(3)}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Supplier</div>
                    <p style="color: var(--dark);">${spirit.supplier || 'Not specified'}</p>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Notes</div>
                    <p style="color: var(--dark);">${spirit.notes || 'No additional notes'}</p>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-outline" onclick="closeComponentModal()" style="flex: 1;">Close</button>
                    <button class="btn btn-primary" onclick="closeComponentModal()" style="flex: 1;">OK</button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function closeComponentModal() {
            document.getElementById('componentReferenceModal').style.display = 'none';
        }

        // Edit Cocktail Function
        function editCocktail(venueId, cocktailId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktail = venue.cocktails.find(c => c.id === cocktailId);
            
            if (!cocktail) return;
            
            const modal = document.getElementById('addCocktailModal');
            
            document.getElementById('venueSelectionField').style.display = 'none';
            
            setCocktailCategory(cocktail.category || 'signature');
            document.getElementById('cocktailName').value = cocktail.name;
            document.getElementById('cocktailFamily').value = cocktail.family || 'Signature';
            document.getElementById('cocktailCostPrice').value = cocktail.pourCost.toFixed(2);
            document.getElementById('cocktailSellingPrice').value = cocktail.sellingPrice;
            document.getElementById('cocktailGlass').value = cocktail.glassware;
            document.getElementById('cocktailGarnish').value = cocktail.garnish;
            document.getElementById('cocktailMethod').value = cocktail.method || '';
            document.getElementById('cocktailNotes').value = cocktail.notes || '';
            
            const dilutionPreset = cocktail.dilutionPreset || 'none';
            document.querySelectorAll('input[name="dilutionPreset"]').forEach(radio => {
                radio.checked = radio.value === dilutionPreset;
            });
            
            const tbody = document.getElementById('ingredientTableBody');
            tbody.innerHTML = '';
            
            cocktail.recipe.forEach(item => {
                const newRow = document.createElement('tr');
                newRow.className = 'ingredient-row';
                newRow.innerHTML = `
                    <td class="ingredient-search">
                        <input type="text" value="${item.ingredient}" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onkeyup="searchIngredients(this)" autocomplete="off" required>
                        <div class="autocomplete-list" id="autocomplete-${Date.now()}"></div>
                    </td>
                    <td><input type="number" value="${item.bottleSize || 750}" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td><input type="number" value="${item.bottleCost || 0}" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td><input type="number" value="${item.amount}" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td>
                        <select style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="convertUnit(this)">
                            <option value="ml" ${item.unit === 'ml' ? 'selected' : ''}>ml</option>
                            <option value="dash" ${item.unit === 'dash' ? 'selected' : ''}>dash</option>
                        </select>
                    </td>
                    <td><input type="number" value="${item.pourCost || 0}" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="pour-cost"></td>
                    <td><input type="number" value="${item.abv || 40}" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientABV(this)" required></td>
                    <td><button type="button" onclick="removeIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(newRow);
                
                if (item.spiritId) {
                    newRow.dataset.spiritId = item.spiritId;
                }
                
                const bottleSize = item.bottleSize || 750;
                const bottleCost = item.bottleCost || 0;
                let pour = item.amount;
                if (item.unit === 'dash') {
                    pour = pour * DASH_TO_ML;
                }
                const pourCost = bottleSize > 0 ? (pour / bottleSize) * bottleCost : 0;
                const pourCostInput = newRow.cells[5].querySelector('input');
                pourCostInput.value = pourCost.toFixed(3);
            });
            
            addIngredientRow();
            
            const form = document.getElementById('newCocktailForm');
            form.onsubmit = (e) => updateCocktail(e, venueId, cocktailId);
            
            modal.style.display = 'flex';
            
            calculateFinalABV();
            calculateTotalPourCost();
        }

        // Update Cocktail Function
        function updateCocktail(event, venueId, cocktailId) {
            event.preventDefault();
            
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktail = venue.cocktails.find(c => c.id === cocktailId);
            
            if (!cocktail) return;
            
            let dilutionPreset = 'none';
            let customDilution = null;
            
            const selectedDilution = document.querySelector('input[name="dilutionPreset"]:checked');
            if (selectedDilution) {
                dilutionPreset = selectedDilution.value;
            }
            
            const useCustom = document.getElementById('useCustomDilution');
            if (useCustom && useCustom.checked) {
                const customValue = document.getElementById('customDilutionValue');
                if (customValue && customValue.value) {
                    customDilution = parseFloat(customValue.value) / 100;
                }
            }
            
            const rows = document.querySelectorAll('.ingredient-row');
            const recipe = [];
            let totalPourCost = 0;
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const unitSelect = row.querySelector('select');
                if (inputs[0].value && inputs[1].value && inputs[3].value) {
                    const spiritId = row.dataset.spiritId || null;
                    const unit = unitSelect ? unitSelect.value : 'ml';
                    let pourAmount = parseFloat(inputs[3].value);
                    
                    // Convert to ml for calculation
                    if (unit === 'dash') {
                        pourAmount = pourAmount * DASH_TO_ML;
                    }
                    
                    const pourCost = (pourAmount / parseFloat(inputs[1].value)) * parseFloat(inputs[2].value);
                    totalPourCost += pourCost;
                    
                    recipe.push({
                        ingredient: inputs[0].value,
                        bottleSize: parseFloat(inputs[1].value),
                        bottleCost: parseFloat(inputs[2].value),
                        amount: parseFloat(inputs[3].value),
                        unit: unit,
                        pourCost: pourCost,
                        abv: parseFloat(inputs[6].value) || 0,
                        spiritId: spiritId
                    });
                }
            });
            
            const sellingPrice = parseFloat(document.getElementById('cocktailSellingPrice').value);
            const cogs = (totalPourCost / sellingPrice * 100);
            
            const totalAlcohol = recipe.reduce((acc, item) => {
                let amount = item.amount;
                if (item.unit === 'dash') {
                    amount = amount * DASH_TO_ML;
                }
                return acc + (amount * (item.abv / 100));
            }, 0);
            
            const totalVolume = recipe.reduce((acc, item) => {
                let amount = item.amount;
                if (item.unit === 'dash') {
                    amount = amount * DASH_TO_ML;
                }
                return acc + amount;
            }, 0);
            
            const dilutionFactor = customDilution || AppState.dilutionPresets[dilutionPreset] || 0;
            const finalAbv = totalVolume > 0 ? (totalAlcohol / totalVolume) / (1 + dilutionFactor) * 100 : 0;
            
            cocktail.name = document.getElementById('cocktailName').value;
            cocktail.category = document.getElementById('cocktailCategory').value;
            cocktail.family = document.getElementById('cocktailFamily').value;
            cocktail.recipe = recipe;
            cocktail.pourCost = totalPourCost;
            cocktail.sellingPrice = sellingPrice;
            cocktail.cogs = parseFloat(cogs.toFixed(1));
            cocktail.finalAbv = parseFloat(finalAbv.toFixed(1));
            cocktail.method = document.getElementById('cocktailMethod').value;
            cocktail.garnish = document.getElementById('cocktailGarnish').value;
            cocktail.glassware = document.getElementById('cocktailGlass').value;
            cocktail.notes = document.getElementById('cocktailNotes').value;
            cocktail.dilutionPreset = dilutionPreset;
            cocktail.customDilution = customDilution;
            
            closeModal('addCocktailModal');
            
            const form = document.getElementById('newCocktailForm');
            form.onsubmit = saveNewCocktail;
            document.getElementById('venueSelectionField').style.display = 'block';
            
            renderCocktailDetail(venueId, cocktailId);
            showToast(` ${cocktail.name} updated successfully`);
        }

        // Modal Functions
        function openAddCocktailModal() {
            const modal = document.getElementById('addCocktailModal');
            
            document.getElementById('venueSelectionField').style.display = 'block';
            
            document.getElementById('newCocktailForm').reset();
            
            setCocktailCategory('signature');
            document.getElementById('dilutionNone').checked = true;
            document.getElementById('useCustomDilution').checked = false;
            document.getElementById('customDilutionValue').style.display = 'none';
            document.getElementById('customDilutionValue').disabled = true;
            document.getElementById('cocktailCostPrice').value = '0.00';
            
            const form = document.getElementById('newCocktailForm');
            form.onsubmit = saveNewCocktail;
            
            const tbody = document.getElementById('ingredientTableBody');
            tbody.innerHTML = `
                <tr class="ingredient-row">
                    <td class="ingredient-search">
                        <input type="text" placeholder="Search or type ingredient" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onkeyup="searchIngredients(this)" autocomplete="off" required>
                        <div class="autocomplete-list" id="autocomplete-0"></div>
                    </td>
                    <td><input type="number" placeholder="750" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="50" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                    <td>
                        <select style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="convertUnit(this)">
                            <option value="ml">ml</option>
                            <option value="dash">dash</option>
                        </select>
                    </td>
                    <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="pour-cost"></td>
                    <td><input type="number" placeholder="40" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientABV(this)" required></td>
                    <td><button type="button" onclick="removeIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
            
            populateVenueDropdown();
            
            modal.style.display = 'flex';
            
            calculateFinalABV();
        }

        function openAddCocktailModalForVenue(venueId) {
            openAddCocktailModal();
            
            document.getElementById('venueSelectionField').style.display = 'none';
            document.getElementById('cocktailVenue').value = venueId;
        }

        function toggleCustomDilution() {
            const checkbox = document.getElementById('useCustomDilution');
            const customInput = document.getElementById('customDilutionValue');
            if (checkbox.checked) {
                customInput.style.display = 'block';
                customInput.disabled = false;
            } else {
                customInput.style.display = 'none';
                customInput.disabled = true;
            }
        }

        function openAddVenueModal() {
            const venueName = prompt('Enter new venue name:');
            if (venueName) {
                const location = prompt('Enter venue location:');
                const newVenue = {
                    id: AppState.nextVenueId++,
                    name: venueName,
                    location: location || 'TBD',
                    image: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400',
                    order: AppState.venues.length + 1,
                    cocktails: []
                };
                AppState.venues.push(newVenue);
                
                if (AppState.currentView === 'venues') {
                    renderVenuesGrid();
                }
                
                showToast(` ${venueName} added successfully`);
            }
        }

        // Ingredient Functions
        function calculateIngredientCost(input) {
            const row = input.closest('tr');
            const bottleSize = parseFloat(row.cells[1].querySelector('input').value) || 0;
            const bottleCost = parseFloat(row.cells[2].querySelector('input').value) || 0;
            let pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const unitSelect = row.querySelector('select');
            
            // Convert to ml for calculation
            if (unitSelect && unitSelect.value === 'dash') {
                pour = pour * DASH_TO_ML;
            }
            
            const pourCostInput = row.cells[5].querySelector('input');
            
            const pourCost = bottleSize > 0 ? (pour / bottleSize) * bottleCost : 0;
            pourCostInput.value = pourCost.toFixed(3);
            
            calculateTotalPourCost();
            calculateFinalABV();
        }

        function calculateIngredientABV(input) {
            calculateFinalABV();
        }

        function calculateTotalPourCost() {
            const pourCostInputs = document.querySelectorAll('.pour-cost');
            let total = 0;
            pourCostInputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            document.getElementById('cocktailCostPrice').value = total.toFixed(2);
            calculateCOGS();
        }

        function calculateCOGS() {
            const pourCost = parseFloat(document.getElementById('cocktailCostPrice').value) || 0;
            const sellingPrice = parseFloat(document.getElementById('cocktailSellingPrice').value) || 1;
            const cogs = ((pourCost / sellingPrice) * 100).toFixed(1);
        }

        function calculateFinalABV() {
            const rows = document.querySelectorAll('.ingredient-row');
            let totalAlcohol = 0;
            let totalVolume = 0;
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const unitSelect = row.querySelector('select');
                if (inputs[0].value && inputs[3].value && inputs[6].value) {
                    let amount = parseFloat(inputs[3].value) || 0;
                    if (unitSelect && unitSelect.value === 'dash') {
                        amount = amount * DASH_TO_ML;
                    }
                    const abv = parseFloat(inputs[6].value) || 0;
                    totalAlcohol += amount * (abv / 100);
                    totalVolume += amount;
                }
            });
            
            const selectedDilution = document.querySelector('input[name="dilutionPreset"]:checked');
            let dilutionFactor = 0;
            if (selectedDilution) {
                dilutionFactor = AppState.dilutionPresets[selectedDilution.value] || 0;
            }
            
            const useCustom = document.getElementById('useCustomDilution');
            if (useCustom && useCustom.checked) {
                const customValue = document.getElementById('customDilutionValue');
                if (customValue && customValue.value) {
                    dilutionFactor = parseFloat(customValue.value) / 100;
                }
            }
            
            const finalAbv = totalVolume > 0 ? (totalAlcohol / totalVolume) / (1 + dilutionFactor) * 100 : 0;
            document.getElementById('finalAbvValue').textContent = `${finalAbv.toFixed(1)}%`;
        }

        function addIngredientRow() {
            const tbody = document.getElementById('ingredientTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'ingredient-row';
            newRow.innerHTML = `
                <td class="ingredient-search">
                    <input type="text" placeholder="Search or type ingredient" style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onkeyup="searchIngredients(this)" autocomplete="off" required>
                    <div class="autocomplete-list" id="autocomplete-${Date.now()}"></div>
                </td>
                <td><input type="number" placeholder="750" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                <td><input type="number" placeholder="25" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientCost(this)" required></td>
                <td>
                    <select style="width: 100%; padding: 0.5rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px;" onchange="convertUnit(this)">
                        <option value="ml">ml</option>
                        <option value="dash">dash</option>
                    </select>
                </td>
                <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="pour-cost"></td>
                <td><input type="number" placeholder="40" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateIngredientABV(this)" required></td>
                <td><button type="button" onclick="removeIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
            `;
            tbody.appendChild(newRow);
        }

        function removeIngredientRow(button) {
            const row = button.closest('tr');
            const tbody = row.parentNode;
            if (tbody.children.length > 1) {
                row.remove();
                calculateTotalPourCost();
                calculateFinalABV();
            } else {
                showToast('At least one ingredient is required');
            }
        }

        // Image Upload
        function uploadCocktailImage(venueId, cocktailId, event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const venue = AppState.venues.find(v => v.id === venueId);
                    const cocktail = venue.cocktails.find(c => c.id === cocktailId);
                    cocktail.image = e.target.result;
                    
                    const detailImage = document.getElementById('cocktailDetailImage');
                    if (detailImage) {
                        detailImage.src = e.target.result;
                    }
                    
                    showToast(' Cocktail image updated');
                };
                reader.readAsDataURL(file);
            }
        }

        // Save New Cocktail
        function saveNewCocktail(event) {
            event.preventDefault();
            
            const category = document.getElementById('cocktailCategory').value;
            
            if (category === 'classic') {
                saveNewClassicCocktail(event);
                return;
            }
            
            const venueId = parseInt(document.getElementById('cocktailVenue').value);
            const venue = AppState.venues.find(v => v.id === venueId);
            
            if (!venue) {
                showToast('Please select a venue');
                return;
            }
            
            let dilutionPreset = 'none';
            let customDilution = null;
            
            const selectedDilution = document.querySelector('input[name="dilutionPreset"]:checked');
            if (selectedDilution) {
                dilutionPreset = selectedDilution.value;
            }
            
            const useCustom = document.getElementById('useCustomDilution');
            if (useCustom && useCustom.checked) {
                const customValue = document.getElementById('customDilutionValue');
                if (customValue && customValue.value) {
                    customDilution = parseFloat(customValue.value) / 100;
                }
            }
            
            const rows = document.querySelectorAll('.ingredient-row');
            const recipe = [];
            let totalPourCost = 0;
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const unitSelect = row.querySelector('select');
                if (inputs[0].value && inputs[1].value && inputs[3].value) {
                    const spiritId = row.dataset.spiritId || null;
                    const unit = unitSelect ? unitSelect.value : 'ml';
                    let pourAmount = parseFloat(inputs[3].value);
                    
                    // Convert to ml for calculation
                    if (unit === 'dash') {
                        pourAmount = pourAmount * DASH_TO_ML;
                    }
                    
                    const pourCost = (pourAmount / parseFloat(inputs[1].value)) * parseFloat(inputs[2].value);
                    totalPourCost += pourCost;
                    
                    recipe.push({
                        ingredient: inputs[0].value,
                        bottleSize: parseFloat(inputs[1].value),
                        bottleCost: parseFloat(inputs[2].value),
                        amount: parseFloat(inputs[3].value),
                        unit: unit,
                        pourCost: pourCost,
                        abv: parseFloat(inputs[6].value) || 0,
                        spiritId: spiritId
                    });
                }
            });
            
            const sellingPrice = parseFloat(document.getElementById('cocktailSellingPrice').value);
            const cogs = (totalPourCost / sellingPrice * 100);
            
            const totalAlcohol = recipe.reduce((acc, item) => {
                let amount = item.amount;
                if (item.unit === 'dash') {
                    amount = amount * DASH_TO_ML;
                }
                return acc + (amount * (item.abv / 100));
            }, 0);
            
            const totalVolume = recipe.reduce((acc, item) => {
                let amount = item.amount;
                if (item.unit === 'dash') {
                    amount = amount * DASH_TO_ML;
                }
                return acc + amount;
            }, 0);
            
            const dilutionFactor = customDilution || AppState.dilutionPresets[dilutionPreset] || 0;
            const finalAbv = totalVolume > 0 ? (totalAlcohol / totalVolume) / (1 + dilutionFactor) * 100 : 0;
            
            const newCocktail = {
                id: AppState.nextCocktailId++,
                name: document.getElementById('cocktailName').value,
                category: 'signature',
                family: document.getElementById('cocktailFamily').value,
                favorite: false,
                image: 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400',
                recipe: recipe,
                pourCost: totalPourCost,
                sellingPrice: sellingPrice,
                cogs: parseFloat(cogs.toFixed(1)),
                finalAbv: parseFloat(finalAbv.toFixed(1)),
                method: document.getElementById('cocktailMethod').value,
                garnish: document.getElementById('cocktailGarnish').value,
                glassware: document.getElementById('cocktailGlass').value,
                dilutionPreset: dilutionPreset,
                customDilution: customDilution,
                batchSize: 1,
                notes: document.getElementById('cocktailNotes').value,
                dateAdded: new Date().toISOString().split('T')[0],
                author: 'Bar Manager',
                order: venue.cocktails.length + 1
            };
            
            venue.cocktails.push(newCocktail);
            
            closeModal('addCocktailModal');
            
            if (AppState.currentView === 'cocktails' && AppState.selectedVenue === venueId) {
                renderCocktailList(venueId);
            }
            
            showToast(` ${newCocktail.name} added to ${venue.name}`);
        }

        // Save New Classic Cocktail
        function saveNewClassicCocktail(event) {
            event.preventDefault();
            
            let dilutionPreset = 'none';
            let customDilution = null;
            
            const selectedDilution = document.querySelector('input[name="dilutionPreset"]:checked');
            if (selectedDilution) {
                dilutionPreset = selectedDilution.value;
            }
            
            const useCustom = document.getElementById('useCustomDilution');
            if (useCustom && useCustom.checked) {
                const customValue = document.getElementById('customDilutionValue');
                if (customValue && customValue.value) {
                    customDilution = parseFloat(customValue.value) / 100;
                }
            }
            
            const rows = document.querySelectorAll('.ingredient-row');
            const recipe = [];
            let totalPourCost = 0;
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const unitSelect = row.querySelector('select');
                if (inputs[0].value && inputs[1].value && inputs[3].value) {
                    const spiritId = row.dataset.spiritId || null;
                    const unit = unitSelect ? unitSelect.value : 'ml';
                    let pourAmount = parseFloat(inputs[3].value);
                    
                    // Convert to ml for calculation
                    if (unit === 'dash') {
                        pourAmount = pourAmount * DASH_TO_ML;
                    }
                    
                    const pourCost = (pourAmount / parseFloat(inputs[1].value)) * parseFloat(inputs[2].value);
                    totalPourCost += pourCost;
                    
                    recipe.push({
                        ingredient: inputs[0].value,
                        bottleSize: parseFloat(inputs[1].value),
                        bottleCost: parseFloat(inputs[2].value),
                        amount: parseFloat(inputs[3].value),
                        unit: unit,
                        pourCost: pourCost,
                        abv: parseFloat(inputs[6].value) || 0,
                        spiritId: spiritId
                    });
                }
            });
            
            const sellingPrice = parseFloat(document.getElementById('cocktailSellingPrice').value);
            const cogs = (totalPourCost / sellingPrice * 100);
            
            const totalAlcohol = recipe.reduce((acc, item) => {
                let amount = item.amount;
                if (item.unit === 'dash') {
                    amount = amount * DASH_TO_ML;
                }
                return acc + (amount * (item.abv / 100));
            }, 0);
            
            const totalVolume = recipe.reduce((acc, item) => {
                let amount = item.amount;
                if (item.unit === 'dash') {
                    amount = amount * DASH_TO_ML;
                }
                return acc + amount;
            }, 0);
            
            const dilutionFactor = customDilution || AppState.dilutionPresets[dilutionPreset] || 0;
            const finalAbv = totalVolume > 0 ? (totalAlcohol / totalVolume) / (1 + dilutionFactor) * 100 : 0;
            
            const newCocktail = {
                id: AppState.nextClassicCocktailId++,
                name: document.getElementById('cocktailName').value,
                category: 'classic',
                family: document.getElementById('cocktailFamily').value,
                favorite: false,
                image: 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=400',
                recipe: recipe,
                pourCost: totalPourCost,
                sellingPrice: sellingPrice,
                cogs: parseFloat(cogs.toFixed(1)),
                finalAbv: parseFloat(finalAbv.toFixed(1)),
                method: document.getElementById('cocktailMethod').value,
                garnish: document.getElementById('cocktailGarnish').value,
                glassware: document.getElementById('cocktailGlass').value,
                dilutionPreset: dilutionPreset,
                customDilution: customDilution,
                batchSize: 1,
                notes: document.getElementById('cocktailNotes').value,
                dateAdded: new Date().toISOString().split('T')[0],
                author: 'Classic Recipe'
            };
            
            AppState.classicCocktails.push(newCocktail);
            
            closeModal('addCocktailModal');
            
            if (AppState.currentView === 'classic') {
                renderClassicCocktails();
            }
            
            showToast(` Classic cocktail ${newCocktail.name} added`);
        }

        // Infusion Functions - FIXED with Excel Template
        function openAddInfusionModal() {
            const modal = document.getElementById('addInfusionModal');
            if (!modal) {
                showToast(' Infusion modal not found');
                return;
            }
            
            document.getElementById('newInfusionForm').reset();
            
            const tbody = document.getElementById('infusionIngredientTableBody');
            tbody.innerHTML = `
                <tr class="infusion-ingredient-row">
                    <td><input type="text" placeholder="Ingredient" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="500" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="50" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="infusion-pour-cost"></td>
                    <td><input type="number" placeholder="47" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionTotalABV(this)" required></td>
                    <td><input type="number" class="infusion-scaling" value="3" min="0.1" step="0.1" style="width: 80px; padding: 0.5rem;" onchange="calculateInfusionScaling()"></td>
                    <td><input type="number" placeholder="0" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="infusion-scaled-pour"></td>
                    <td><button type="button" onclick="removeInfusionIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
            
            document.getElementById('infusionTotalPour').value = '0';
            document.getElementById('infusionTotalPourCost').value = '0.00';
            document.getElementById('infusionTotalScaledPour').value = '0';
            document.getElementById('infusionGlobalScaling').value = '3';
            document.getElementById('infusionYield').value = '0';
            document.getElementById('infusionDate').value = new Date().toLocaleDateString();
            
            modal.style.display = 'flex';
        }

        function addInfusionIngredientRow() {
            const tbody = document.getElementById('infusionIngredientTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'infusion-ingredient-row';
            newRow.innerHTML = `
                <td><input type="text" placeholder="Ingredient" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                <td><input type="number" placeholder="500" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                <td><input type="number" placeholder="50" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionIngredientCost(this)" required></td>
                <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="infusion-pour-cost"></td>
                <td><input type="number" placeholder="47" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateInfusionTotalABV(this)" required></td>
                <td><input type="number" class="infusion-scaling" value="3" min="0.1" step="0.1" style="width: 80px; padding: 0.5rem;" onchange="calculateInfusionScaling()"></td>
                <td><input type="number" placeholder="0" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="infusion-scaled-pour"></td>
                <td><button type="button" onclick="removeInfusionIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
            `;
            tbody.appendChild(newRow);
        }

        function removeInfusionIngredientRow(button) {
            const row = button.closest('tr');
            const tbody = row.parentNode;
            if (tbody.children.length > 1) {
                row.remove();
                calculateInfusionTotals();
            } else {
                showToast('At least one ingredient is required');
            }
        }

        function calculateInfusionIngredientCost(input) {
            const row = input.closest('tr');
            const bottleSize = parseFloat(row.cells[1].querySelector('input').value) || 0;
            const bottleCost = parseFloat(row.cells[2].querySelector('input').value) || 0;
            const pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const pourCostInput = row.cells[4].querySelector('input');
            
            const pourCost = bottleSize > 0 ? (pour / bottleSize) * bottleCost : 0;
            pourCostInput.value = pourCost.toFixed(3);
            
            calculateInfusionTotals();
        }

        function calculateInfusionTotalABV(input) {
            const row = input.closest('tr');
            const abv = parseFloat(row.cells[5].querySelector('input').value) || 0;
            const pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const totalAbvInput = row.cells[6].querySelector('input');
            
            totalAbvInput.value = (abv * pour / 100).toFixed(2);
            
            calculateInfusionTotals();
        }

        function calculateInfusionTotals() {
            const rows = document.querySelectorAll('#infusionIngredientTableBody .infusion-ingredient-row');
            let totalPour = 0;
            let totalPourCost = 0;
            let totalAbv = 0;
            
            rows.forEach(row => {
                const pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
                const pourCost = parseFloat(row.cells[4].querySelector('input').value) || 0;
                const totalAbvValue = parseFloat(row.cells[6].querySelector('input').value) || 0;
                
                totalPour += pour;
                totalPourCost += pourCost;
                totalAbv += totalAbvValue;
            });
            
            document.getElementById('infusionTotalPour').value = totalPour.toFixed(1);
            document.getElementById('infusionTotalPourCost').value = totalPourCost.toFixed(2);
            
            calculateInfusionScaling();
        }

        function calculateInfusionScaling() {
            const rows = document.querySelectorAll('#infusionIngredientTableBody .infusion-ingredient-row');
            const globalScaling = parseFloat(document.getElementById('infusionGlobalScaling').value) || 3;
            
            let totalScaledPour = 0;
            
            rows.forEach(row => {
                const pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
                const scalingInput = row.cells[7].querySelector('input');
                scalingInput.value = globalScaling;
                const scaledPour = pour * globalScaling;
                row.cells[8].querySelector('input').value = scaledPour.toFixed(1);
                totalScaledPour += scaledPour;
            });
            
            document.getElementById('infusionTotalScaledPour').value = totalScaledPour.toFixed(1);
            
            const yield_ml = totalScaledPour - (totalScaledPour * 0.2);
            document.getElementById('infusionYield').value = yield_ml.toFixed(1);
        }

        function updateInfusionScalingFactor() {
            const globalScaling = parseFloat(document.getElementById('infusionGlobalScaling').value) || 3;
            calculateInfusionScaling();
        }

        function saveNewInfusion(event) {
            event.preventDefault();
            
            const rows = document.querySelectorAll('#infusionIngredientTableBody .infusion-ingredient-row');
            const ingredients = [];
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value && inputs[1].value && inputs[3].value) {
                    ingredients.push({
                        ingredient: inputs[0].value,
                        volume: parseFloat(inputs[1].value),
                        cost: parseFloat(inputs[2].value),
                        pour: parseFloat(inputs[3].value),
                        pourCost: parseFloat(inputs[4].value),
                        abv: parseFloat(inputs[5].value) || 0,
                        totalAbv: parseFloat(inputs[6].value),
                        scaling: parseFloat(inputs[7].value),
                        scaledPour: parseFloat(inputs[8].value)
                    });
                }
            });
            
            const newInfusion = {
                id: AppState.nextInfusionId++,
                name: document.getElementById('infusionName').value,
                category: document.getElementById('infusionCategory').value,
                base: document.getElementById('infusionBase').value,
                author: document.getElementById('infusionAuthor').value,
                date: document.getElementById('infusionDate').value,
                ingredients: ingredients,
                totalPour: parseFloat(document.getElementById('infusionTotalPour').value),
                totalPourCost: parseFloat(document.getElementById('infusionTotalPourCost').value),
                scalingFactor: parseFloat(document.getElementById('infusionGlobalScaling').value),
                totalScaledPour: parseFloat(document.getElementById('infusionTotalScaledPour').value),
                yield: parseFloat(document.getElementById('infusionYield').value),
                usedIn: document.getElementById('infusionUsedIn').value,
                instructions: document.getElementById('infusionInstructions').value,
                allergens: document.getElementById('infusionAllergens').value,
                notes: document.getElementById('infusionNotes').value,
                progress: 0,
                created: new Date().toISOString().split('T')[0]
            };
            
            AppState.infusions.push(newInfusion);
            
            closeModal('addInfusionModal');
            renderInfusion();
            showToast(` ${newInfusion.name} infusion created`);
        }

        // Distillation Functions - FIXED with Excel Template
        function openAddDistillationModal() {
            const modal = document.getElementById('addDistillationModal');
            if (!modal) {
                showToast(' Distillation modal not found');
                return;
            }
            
            document.getElementById('newDistillationForm').reset();
            
            const tbody = document.getElementById('distillationIngredientTableBody');
            tbody.innerHTML = `
                <tr class="distillation-ingredient-row">
                    <td><input type="text" placeholder="Juniper" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="1000" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="30" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                    <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="distillation-pour-cost"></td>
                    <td><input type="number" placeholder="40" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationTotalABV(this)" required></td>
                    <td><input type="number" class="distillation-scaling" value="3" min="0.1" step="0.1" style="width: 80px; padding: 0.5rem;" onchange="calculateDistillationScaling()"></td>
                    <td><input type="number" placeholder="0" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="distillation-scaled-pour"></td>
                    <td><button type="button" onclick="removeDistillationIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
            
            document.getElementById('distillationTotalPour').value = '0';
            document.getElementById('distillationTotalPourCost').value = '0.00';
            document.getElementById('distillationTotalScaledPour').value = '0';
            document.getElementById('distillationGlobalScaling').value = '3';
            document.getElementById('distillationYield').value = '0';
            document.getElementById('distillationDate').value = new Date().toLocaleDateString();
            document.getElementById('distillationTargetABV').value = '47';
            
            modal.style.display = 'flex';
        }

        function addDistillationIngredientRow() {
            const tbody = document.getElementById('distillationIngredientTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'distillation-ingredient-row';
            newRow.innerHTML = `
                <td><input type="text" placeholder="Botanical" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                <td><input type="number" placeholder="1000" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                <td><input type="number" placeholder="0" step="0.01" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                <td><input type="number" placeholder="30" step="0.1" min="0" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationIngredientCost(this)" required></td>
                <td><input type="number" placeholder="0.00" step="0.001" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="distillation-pour-cost"></td>
                <td><input type="number" placeholder="40" step="0.1" min="0" max="100" style="width: 100%; padding: 0.5rem;" onchange="calculateDistillationTotalABV(this)" required></td>
                <td><input type="number" class="distillation-scaling" value="3" min="0.1" step="0.1" style="width: 80px; padding: 0.5rem;" onchange="calculateDistillationScaling()"></td>
                <td><input type="number" placeholder="0" readonly style="width: 100%; padding: 0.5rem; background: var(--light);" class="distillation-scaled-pour"></td>
                <td><button type="button" onclick="removeDistillationIngredientRow(this)" style="background: none; border: none; color: var(--danger);"><i class="fas fa-trash"></i></button></td>
            `;
            tbody.appendChild(newRow);
        }

        function removeDistillationIngredientRow(button) {
            const row = button.closest('tr');
            const tbody = row.parentNode;
            if (tbody.children.length > 1) {
                row.remove();
                calculateDistillationTotals();
            } else {
                showToast('At least one botanical is required');
            }
        }

        function calculateDistillationIngredientCost(input) {
            const row = input.closest('tr');
            const bottleSize = parseFloat(row.cells[1].querySelector('input').value) || 0;
            const bottleCost = parseFloat(row.cells[2].querySelector('input').value) || 0;
            const pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const pourCostInput = row.cells[4].querySelector('input');
            
            const pourCost = bottleSize > 0 ? (pour / bottleSize) * bottleCost : 0;
            pourCostInput.value = pourCost.toFixed(3);
            
            calculateDistillationTotals();
        }

        function calculateDistillationTotalABV(input) {
            const row = input.closest('tr');
            const abv = parseFloat(row.cells[5].querySelector('input').value) || 0;
            const pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const totalAbvInput = row.cells[6].querySelector('input');
            
            totalAbvInput.value = (abv * pour / 100).toFixed(2);
            
            calculateDistillationTotals();
        }

        function calculateDistillationTotals() {
            const rows = document.querySelectorAll('#distillationIngredientTableBody .distillation-ingredient-row');
            let totalPour = 0;
            let totalPourCost = 0;
            let totalAbv = 0;
            
            rows.forEach(row => {
                const pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
                const pourCost = parseFloat(row.cells[4].querySelector('input').value) || 0;
                const totalAbvValue = parseFloat(row.cells[6].querySelector('input').value) || 0;
                
                totalPour += pour;
                totalPourCost += pourCost;
                totalAbv += totalAbvValue;
            });
            
            document.getElementById('distillationTotalPour').value = totalPour.toFixed(1);
            document.getElementById('distillationTotalPourCost').value = totalPourCost.toFixed(2);
            
            calculateDistillationScaling();
        }

        function calculateDistillationScaling() {
            const rows = document.querySelectorAll('#distillationIngredientTableBody .distillation-ingredient-row');
            const globalScaling = parseFloat(document.getElementById('distillationGlobalScaling').value) || 3;
            
            let totalScaledPour = 0;
            
            rows.forEach(row => {
                const pour = parseFloat(row.cells[3].querySelector('input').value) || 0;
                const scalingInput = row.cells[7].querySelector('input');
                scalingInput.value = globalScaling;
                const scaledPour = pour * globalScaling;
                row.cells[8].querySelector('input').value = scaledPour.toFixed(1);
                totalScaledPour += scaledPour;
            });
            
            document.getElementById('distillationTotalScaledPour').value = totalScaledPour.toFixed(1);
            
            const yield_ml = totalScaledPour - (totalScaledPour * 0.2);
            document.getElementById('distillationYield').value = yield_ml.toFixed(1);
        }

        function updateDistillationScalingFactor() {
            const globalScaling = parseFloat(document.getElementById('distillationGlobalScaling').value) || 3;
            calculateDistillationScaling();
        }

        function saveNewDistillation(event) {
            event.preventDefault();
            
            const rows = document.querySelectorAll('#distillationIngredientTableBody .distillation-ingredient-row');
            const botanicals = [];
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value && inputs[1].value && inputs[3].value) {
                    botanicals.push({
                        ingredient: inputs[0].value,
                        volume: parseFloat(inputs[1].value),
                        cost: parseFloat(inputs[2].value),
                        pour: parseFloat(inputs[3].value),
                        pourCost: parseFloat(inputs[4].value),
                        abv: parseFloat(inputs[5].value) || 0,
                        totalAbv: parseFloat(inputs[6].value),
                        scaling: parseFloat(inputs[7].value),
                        scaledPour: parseFloat(inputs[8].value)
                    });
                }
            });
            
            const newDistillation = {
                id: AppState.nextDistillationId++,
                name: document.getElementById('distillationName').value,
                category: document.getElementById('distillationCategory').value,
                base: document.getElementById('distillationBase').value,
                targetABV: parseFloat(document.getElementById('distillationTargetABV').value),
                author: document.getElementById('distillationAuthor').value,
                date: document.getElementById('distillationDate').value,
                botanicals: botanicals,
                totalPour: parseFloat(document.getElementById('distillationTotalPour').value),
                totalPourCost: parseFloat(document.getElementById('distillationTotalPourCost').value),
                scalingFactor: parseFloat(document.getElementById('distillationGlobalScaling').value),
                totalScaledPour: parseFloat(document.getElementById('distillationTotalScaledPour').value),
                yield: parseFloat(document.getElementById('distillationYield').value),
                usedIn: document.getElementById('distillationUsedIn').value,
                instructions: document.getElementById('distillationInstructions').value,
                allergens: document.getElementById('distillationAllergens').value,
                notes: document.getElementById('distillationNotes').value,
                progress: 0,
                created: new Date().toISOString().split('T')[0]
            };
            
            AppState.distillations.push(newDistillation);
            
            closeModal('addDistillationModal');
            renderDistillation();
            showToast(` ${newDistillation.name} distillation created`);
        }

        // Render Infusion Page
        function renderInfusion() {
            mainContent.innerHTML = `
                <div class="top-header">
                    <h1 class="page-title">
                        <i class="fas fa-flask"></i>
                        Infusion Lab
                    </h1>
                    <button class="btn btn-primary" onclick="openAddInfusionModal()">
                        <i class="fas fa-plus"></i> New Infusion
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem;">
                    ${AppState.infusions.length > 0 ? AppState.infusions.map(infusion => `
                        <div style="background: var(--white); border-radius: 20px; padding: 1.5rem; border-left: 4px solid var(--accent);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <div style="font-weight: 600; color: var(--primary); font-size: 1.1rem;">${infusion.name}</div>
                                <span style="background: rgba(230,126,34,0.1); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">${infusion.category || 'Infusion'}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                <div><span style="color: var(--gray);">Base:</span> ${infusion.base}</div>
                                <div><span style="color: var(--gray);">Author:</span> ${infusion.author}</div>
                                <div><span style="color: var(--gray);">Date:</span> ${infusion.date}</div>
                                <div><span style="color: var(--gray);">Total Pour:</span> ${infusion.totalPour}ml</div>
                                <div><span style="color: var(--gray);">Pour Cost:</span> $${infusion.totalPourCost.toFixed(2)}</div>
                                <div><span style="color: var(--gray);">Scaling:</span> ${infusion.scalingFactor}x</div>
                                <div><span style="color: var(--gray);">Scaled Vol:</span> ${infusion.totalScaledPour}ml</div>
                                <div><span style="color: var(--gray);">Yield:</span> ${infusion.yield}ml</div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="color: var(--gray); margin-bottom: 0.25rem;">Ingredients</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    ${infusion.ingredients.map(ing => `<span style="background: var(--light); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">${ing.ingredient} ${ing.pour}ml</span>`).join('')}
                                </div>
                            </div>
                            ${infusion.usedIn ? `<div style="background: rgba(44,62,80,0.02); padding: 0.75rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem;"><strong>Used in:</strong> ${infusion.usedIn}</div>` : ''}
                            ${infusion.instructions ? `<div style="background: rgba(44,62,80,0.02); padding: 0.75rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem;"><strong>Instructions:</strong> ${infusion.instructions}</div>` : ''}
                            ${infusion.allergens ? `<div style="background: rgba(231,76,60,0.05); padding: 0.75rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem;"><strong> Allergens:</strong> ${infusion.allergens}</div>` : ''}
                            ${infusion.notes ? `<div style="background: rgba(230,126,34,0.05); padding: 0.75rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem;"> ${infusion.notes}</div>` : ''}
                            <div style="margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                    <span style="font-size: 0.75rem;">Progress</span>
                                    <span style="font-size: 0.75rem; font-weight: 600;">${infusion.progress}%</span>
                                </div>
                                <div style="width: 100%; height: 6px; background: var(--light); border-radius: 3px;">
                                    <div style="width: ${infusion.progress}%; height: 6px; background: var(--accent); border-radius: 3px;"></div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                                <span style="font-size: 0.75rem; color: var(--gray);">Created: ${infusion.created || infusion.date}</span>
                                <button class="btn btn-outline" style="padding: 0.5rem 1rem;" onclick="updateInfusionProgress(${infusion.id})">Update</button>
                            </div>
                        </div>
                    `).join('') : `
                        <div style="background: var(--white); border-radius: 20px; padding: 3rem; text-align: center; grid-column: 1 / -1;">
                            <i class="fas fa-flask" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem;"></i>
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">No Infusions Yet</h3>
                            <p style="color: var(--gray); margin-bottom: 1.5rem;">Start your first infusion by clicking the button above.</p>
                            <button class="btn btn-primary" onclick="openAddInfusionModal()">
                                <i class="fas fa-plus"></i> Create Infusion
                            </button>
                        </div>
                    `}
                </div>
            `;
        }

        // Render Distillation Page
        function renderDistillation() {
            mainContent.innerHTML = `
                <div class="top-header">
                    <h1 class="page-title">
                        <i class="fas fa-wine-bottle"></i>
                        Distillation
                    </h1>
                    <button class="btn btn-primary" onclick="openAddDistillationModal()">
                        <i class="fas fa-plus"></i> New Distillation
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem;">
                    ${AppState.distillations.length > 0 ? AppState.distillations.map(distillation => `
                        <div style="background: var(--white); border-radius: 20px; padding: 1.5rem; border-left: 4px solid var(--accent);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <div style="font-weight: 600; color: var(--primary); font-size: 1.1rem;">${distillation.name}</div>
                                <span style="background: rgba(230,126,34,0.1); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">${distillation.targetABV}% ABV</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                <div><span style="color: var(--gray);">Base:</span> ${distillation.base}</div>
                                <div><span style="color: var(--gray);">Category:</span> ${distillation.category || 'Spirit'}</div>
                                <div><span style="color: var(--gray);">Author:</span> ${distillation.author}</div>
                                <div><span style="color: var(--gray);">Date:</span> ${distillation.date}</div>
                                <div><span style="color: var(--gray);">Total Pour:</span> ${distillation.totalPour}ml</div>
                                <div><span style="color: var(--gray);">Pour Cost:</span> $${distillation.totalPourCost.toFixed(2)}</div>
                                <div><span style="color: var(--gray);">Scaling:</span> ${distillation.scalingFactor}x</div>
                                <div><span style="color: var(--gray);">Scaled Vol:</span> ${distillation.totalScaledPour}ml</div>
                                <div><span style="color: var(--gray);">Yield:</span> ${distillation.yield}ml</div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="color: var(--gray); margin-bottom: 0.25rem;">Botanicals</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    ${distillation.botanicals.map(bot => `<span style="background: var(--light); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">${bot.ingredient} ${bot.pour}ml</span>`).join('')}
                                </div>
                            </div>
                            ${distillation.usedIn ? `<div style="background: rgba(44,62,80,0.02); padding: 0.75rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem;"><strong>Used in:</strong> ${distillation.usedIn}</div>` : ''}
                            ${distillation.instructions ? `<div style="background: rgba(44,62,80,0.02); padding: 0.75rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem;"><strong>Instructions:</strong> ${distillation.instructions}</div>` : ''}
                            ${distillation.allergens ? `<div style="background: rgba(231,76,60,0.05); padding: 0.75rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem;"><strong> Allergens:</strong> ${distillation.allergens}</div>` : ''}
                            ${distillation.notes ? `<div style="background: rgba(230,126,34,0.05); padding: 0.75rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem;"> ${distillation.notes}</div>` : ''}
                            <div style="margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                    <span style="font-size: 0.75rem;">Progress</span>
                                    <span style="font-size: 0.75rem; font-weight: 600;">${distillation.progress}%</span>
                                </div>
                                <div style="width: 100%; height: 6px; background: var(--light); border-radius: 3px;">
                                    <div style="width: ${distillation.progress}%; height: 6px; background: var(--accent); border-radius: 3px;"></div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                                <span style="font-size: 0.75rem; color: var(--gray);">Created: ${distillation.created || distillation.date}</span>
                                <button class="btn btn-outline" style="padding: 0.5rem 1rem;" onclick="updateDistillationProgress(${distillation.id})">Update</button>
                            </div>
                        </div>
                    `).join('') : `
                        <div style="background: var(--white); border-radius: 20px; padding: 3rem; text-align: center; grid-column: 1 / -1;">
                            <i class="fas fa-wine-bottle" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem;"></i>
                            <h3 style="color: var(--primary); margin-bottom: 0.5rem;">No Distillations Yet</h3>
                            <p style="color: var(--gray); margin-bottom: 1.5rem;">Start your first distillation by clicking the button above.</p>
                            <button class="btn btn-primary" onclick="openAddDistillationModal()">
                                <i class="fas fa-plus"></i> Start Distillation
                            </button>
                        </div>
                    `}
                </div>
            `;
        }

        // Progress Update Functions
        function updateInfusionProgress(id) {
            const infusion = AppState.infusions.find(i => i.id === id);
            if (infusion) {
                infusion.progress = Math.min(infusion.progress + 10, 100);
                renderInfusion();
                showToast(` ${infusion.name} progress updated to ${infusion.progress}%`);
            }
        }

        function updateDistillationProgress(id) {
            const distillation = AppState.distillations.find(d => d.id === id);
            if (distillation) {
                distillation.progress = Math.min(distillation.progress + 15, 100);
                renderDistillation();
                showToast(` ${distillation.name} progress updated to ${distillation.progress}%`);
            }
        }

        // Close Modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Utility Functions
        function toggleFavorite(venueId, cocktailId, event) {
            event.stopPropagation();
            const venue = AppState.venues.find(v => v.id === venueId);
            const cocktail = venue.cocktails.find(c => c.id === cocktailId);
            
            if (cocktail) {
                cocktail.favorite = !cocktail.favorite;
                showToast(cocktail.favorite ? ' Added to favorites' : 'Removed from favorites');
                
                if (AppState.currentView === 'cocktails' && AppState.selectedVenue === venueId) {
                    renderCocktailList(venueId);
                } else if (AppState.currentView === 'detail' && AppState.selectedCocktail === cocktailId) {
                    renderCocktailDetail(venueId, cocktailId);
                }
                
                updateFavoritesList();
            }
        }

        function showToast(message) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <i class="fas fa-check-circle"></i>
                ${message}
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function updateFavoritesList() {
            const favoritesList = document.getElementById('favoritesList');
            if (favoritesList) {
                const favorites = AppState.venues.flatMap(v => 
                    v.cocktails.filter(c => c.favorite)
                );
                
                favoritesList.innerHTML = favorites.map(cocktail => {
                    const venue = AppState.venues.find(v => v.cocktails.includes(cocktail));
                    return `
                        <div class="nav-item" onclick="viewCocktailDetail(${venue.id}, ${cocktail.id})">
                            <i class="fas fa-cocktail"></i>
                            <div style="display: flex; flex-direction: column;">
                                <span>${cocktail.name}</span>
                                <span style="font-size: 0.7rem; color: var(--accent);">${venue.name}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Preview Menu PDF (Overview) - Updated with sheep emoji
        function previewMenuPDF(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const sortedCocktails = [...venue.cocktails].sort((a, b) => a.name.localeCompare(b.name));
            
            let previewHTML = `
                <div style="padding: 1rem;">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <div style="width: 40px; height: 40px; background: #000000; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fas fa-sheep"></i>
                            </div>
                            <h1 style="color: #2C3E50; font-size: 1.75rem;"> BLACK SHEEP</h1>
                        </div>
                        <p style="color: #E67E22; font-weight: 600;">${venue.name} - Cocktail Menu Overview</p>
                        <p style="color: #95A5A6; font-size: 0.875rem;">Generated: ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <table class="pdf-preview-table">
                        <thead>
                            <tr>
                                <th>Cocktail Name</th>
                                <th>Family</th>
                                <th>Final ABV</th>
                                <th>Cost Price</th>
                                <th>Selling Price</th>
                                <th>COGS %</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedCocktails.map(cocktail => `
                                <tr>
                                    <td style="font-weight: 600;">${cocktail.name}</td>
                                    <td>${cocktail.family || 'Signature'}</td>
                                    <td>${cocktail.finalAbv.toFixed(1)}%</td>
                                    <td>$${cocktail.pourCost.toFixed(2)}</td>
                                    <td>$${cocktail.sellingPrice}</td>
                                    <td style="color: ${cocktail.cogs < 25 ? '#27AE60' : cocktail.cogs < 35 ? '#F39C12' : '#E74C3C'}; font-weight: 600;">
                                        ${cocktail.cogs}%
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ECF0F1; text-align: center; color: #95A5A6; font-size: 0.75rem;">
                        <p>Black Sheep Restaurants  Confidential</p>
                    </div>
                </div>
            `;
            
            AppState.pdfPreviewData = { venue, cocktails: sortedCocktails, type: 'menu' };
            AppState.pdfPreviewType = 'menu';
            
            document.getElementById('pdfPreviewTitle').innerHTML = '<i class="fas fa-file-pdf"></i> Menu Overview Preview';
            document.getElementById('pdfPreviewContent').innerHTML = previewHTML;
            document.getElementById('pdfPreviewModal').style.display = 'flex';
        }

        // Preview Specs PDF - Updated with sheep emoji
        function previewSpecsPDF(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const sortedCocktails = [...venue.cocktails].sort((a, b) => a.name.localeCompare(b.name));
            
            let previewHTML = '';
            
            sortedCocktails.forEach(cocktail => {
                previewHTML += `
                    <div class="pdf-spec-card">
                        <div class="pdf-spec-header">
                            <div>
                                <div class="pdf-spec-name">${cocktail.name}</div>
                                <div class="pdf-spec-family">${venue.name}  ${cocktail.family || 'Signature'}</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: #2C3E50; margin-bottom: 0.5rem;">RECIPE</div>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${cocktail.recipe.map(item => `<li style="padding: 0.25rem 0; font-size: 0.875rem; color: #34495E;"> ${item.amount}${item.unit} ${item.ingredient}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div><span style="font-weight: 600;">Glassware:</span> ${cocktail.glassware}</div>
                            <div><span style="font-weight: 600;">Garnish:</span> ${cocktail.garnish}</div>
                        </div>
                        
                        <div>
                            <div style="font-weight: 600; color: #2C3E50; margin-bottom: 0.25rem;">METHOD</div>
                            <p style="color: #34495E; font-size: 0.875rem; line-height: 1.5;">${cocktail.method}</p>
                        </div>
                    </div>
                `;
            });
            
            AppState.pdfPreviewData = { venue, cocktails: sortedCocktails, type: 'specs' };
            AppState.pdfPreviewType = 'specs';
            
            document.getElementById('pdfPreviewTitle').innerHTML = '<i class="fas fa-file-pdf"></i> Cocktail Specs Preview';
            document.getElementById('pdfPreviewContent').innerHTML = previewHTML;
            document.getElementById('pdfPreviewModal').style.display = 'flex';
        }

        // Preview Selected Specs PDF - Updated with sheep emoji
        function previewSelectedSpecsPDF(venueId) {
            const venue = AppState.venues.find(v => v.id === venueId);
            const selectedCocktails = venue.cocktails.filter(c => AppState.selectedCocktailsForPrint.includes(c.id));
            
            if (selectedCocktails.length === 0) {
                showToast(' Please select at least one cocktail to preview');
                return;
            }
            
            let previewHTML = '';
            
            selectedCocktails.forEach(cocktail => {
                previewHTML += `
                    <div class="pdf-spec-card">
                        <div class="pdf-spec-header">
                            <div>
                                <div class="pdf-spec-name">${cocktail.name}</div>
                                <div class="pdf-spec-family">${venue.name}  ${cocktail.family || 'Signature'}</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: #2C3E50; margin-bottom: 0.5rem;">RECIPE</div>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${cocktail.recipe.map(item => `<li style="padding: 0.25rem 0; font-size: 0.875rem; color: #34495E;"> ${item.amount}${item.unit} ${item.ingredient}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div><span style="font-weight: 600;">Glassware:</span> ${cocktail.glassware}</div>
                            <div><span style="font-weight: 600;">Garnish:</span> ${cocktail.garnish}</div>
                        </div>
                        
                        <div>
                            <div style="font-weight: 600; color: #2C3E50; margin-bottom: 0.25rem;">METHOD</div>
                            <p style="color: #34495E; font-size: 0.875rem; line-height: 1.5;">${cocktail.method}</p>
                        </div>
                    </div>
                `;
            });
            
            AppState.pdfPreviewData = { venue, cocktails: selectedCocktails, type: 'selected-specs' };
            AppState.pdfPreviewType = 'selected-specs';
            
            document.getElementById('pdfPreviewTitle').innerHTML = '<i class="fas fa-file-pdf"></i> Selected Cocktail Specs Preview';
            document.getElementById('pdfPreviewContent').innerHTML = previewHTML;
            document.getElementById('pdfPreviewModal').style.display = 'flex';
        }

        // Close PDF Preview
        function closePDFPreview() {
            document.getElementById('pdfPreviewModal').style.display = 'none';
            AppState.pdfPreviewData = null;
            AppState.pdfPreviewType = null;
        }

        // Download PDF from Preview
        async function downloadPDFFromPreview() {
            if (!AppState.pdfPreviewData) return;
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            if (AppState.pdfPreviewType === 'menu') {
                await generateMenuPDF(pdf, AppState.pdfPreviewData.venue, AppState.pdfPreviewData.cocktails);
            } else {
                await generateSpecsPDF(pdf, AppState.pdfPreviewData.venue, AppState.pdfPreviewData.cocktails);
            }
            
            closePDFPreview();
        }

        // Share PDF from Preview
        async function sharePDFFromPreview() {
            if (!AppState.pdfPreviewData) return;
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            if (AppState.pdfPreviewType === 'menu') {
                await generateMenuPDF(pdf, AppState.pdfPreviewData.venue, AppState.pdfPreviewData.cocktails);
            } else {
                await generateSpecsPDF(pdf, AppState.pdfPreviewData.venue, AppState.pdfPreviewData.cocktails);
            }
            
            const pdfBlob = pdf.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `${AppState.pdfPreviewData.venue.name} - Cocktail ${AppState.pdfPreviewType === 'menu' ? 'Menu' : 'Specs'}`,
                        files: [new File([pdfBlob], `${AppState.pdfPreviewData.venue.name}_${AppState.pdfPreviewType}.pdf`, { type: 'application/pdf' })]
                    });
                    showToast(' PDF shared successfully');
                } catch (error) {
                    window.open(pdfUrl, '_blank');
                }
            } else {
                window.open(pdfUrl, '_blank');
            }
            
            closePDFPreview();
        }

        // Generate Menu PDF - Updated with sheep emoji
        async function generateMenuPDF(pdf, venue, cocktails) {
            let yOffset = 20;
            const pageHeight = pdf.internal.pageSize.height;
            const margin = 20;

            pdf.setFillColor(0, 0, 0);
            pdf.circle(30, yOffset, 8, 'F');
            pdf.setTextColor(230, 126, 34);
            pdf.setFontSize(24);
            pdf.setFont('helvetica', 'bold');
            pdf.text(' BLACK SHEEP', 45, yOffset + 5);
            pdf.setTextColor(44, 62, 80);
            pdf.setFontSize(16);
            pdf.text(venue.name, 45, yOffset + 15);
            
            yOffset += 25;
            
            pdf.setDrawColor(230, 126, 34);
            pdf.setLineWidth(0.5);
            pdf.line(margin, yOffset, pdf.internal.pageSize.width - margin, yOffset);
            
            yOffset += 15;

            pdf.setFillColor(236, 240, 241);
            pdf.rect(margin, yOffset - 4, pdf.internal.pageSize.width - 40, 10, 'F');
            pdf.setTextColor(44, 62, 80);
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Cocktail Name', margin + 2, yOffset);
            pdf.text('Family', margin + 60, yOffset);
            pdf.text('ABV', margin + 100, yOffset);
            pdf.text('Cost', margin + 130, yOffset);
            pdf.text('Selling', margin + 155, yOffset);
            pdf.text('COGS', margin + 180, yOffset);
            
            yOffset += 10;

            cocktails.forEach((cocktail, index) => {
                if (yOffset > pageHeight - 20) {
                    pdf.addPage();
                    yOffset = 20;
                }

                pdf.setTextColor(52, 73, 94);
                pdf.setFont('helvetica', 'normal');
                pdf.text(cocktail.name, margin + 2, yOffset);
                pdf.text(cocktail.family || 'Signature', margin + 60, yOffset);
                pdf.text(`${cocktail.finalAbv.toFixed(1)}%`, margin + 100, yOffset);
                pdf.text(`$${cocktail.pourCost.toFixed(2)}`, margin + 130, yOffset);
                pdf.text(`$${cocktail.sellingPrice}`, margin + 155, yOffset);
                
                pdf.setTextColor(cocktail.cogs < 25 ? 39 : cocktail.cogs < 35 ? 243 : 231, 
                               cocktail.cogs < 25 ? 174 : cocktail.cogs < 35 ? 156 : 76, 
                               cocktail.cogs < 25 ? 96 : cocktail.cogs < 35 ? 18 : 60);
                pdf.setFont('helvetica', 'bold');
                pdf.text(`${cocktail.cogs}%`, margin + 180, yOffset);
                
                yOffset += 8;
            });

            pdf.save(`${venue.name}_Menu_Overview.pdf`);
            showToast(` Menu PDF generated`);
        }

        // Generate Specs PDF - Updated with sheep emoji
        async function generateSpecsPDF(pdf, venue, cocktails) {
            let yOffset = 20;
            const pageHeight = pdf.internal.pageSize.height;
            const margin = 20;

            pdf.setFillColor(0, 0, 0);
            pdf.circle(30, yOffset, 8, 'F');
            pdf.setTextColor(230, 126, 34);
            pdf.setFontSize(24);
            pdf.setFont('helvetica', 'bold');
            pdf.text(' BLACK SHEEP', 45, yOffset + 5);
            pdf.setTextColor(44, 62, 80);
            pdf.setFontSize(16);
            pdf.text('COCKTAIL SPECS', 45, yOffset + 15);
            
            yOffset += 25;
            
            pdf.setDrawColor(230, 126, 34);
            pdf.setLineWidth(0.5);
            pdf.line(margin, yOffset, pdf.internal.pageSize.width - margin, yOffset);
            
            yOffset += 15;

            for (let i = 0; i < cocktails.length; i++) {
                const cocktail = cocktails[i];
                
                if (yOffset > pageHeight - 60) {
                    pdf.addPage();
                    yOffset = 20;
                }

                pdf.setTextColor(230, 126, 34);
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.text(cocktail.name, margin, yOffset);
                
                yOffset += 8;
                
                pdf.setTextColor(149, 165, 166);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`${venue.name}  ${cocktail.family || 'Signature'}`, margin, yOffset);
                
                yOffset += 12;

                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('RECIPE', margin, yOffset);
                
                yOffset += 6;
                
                cocktail.recipe.forEach((item) => {
                    pdf.setTextColor(52, 73, 94);
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(` ${item.amount}${item.unit} ${item.ingredient}`, margin + 5, yOffset);
                    yOffset += 5;
                });
                
                yOffset += 5;

                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'bold');
                pdf.text('GLASSWARE:', margin, yOffset);
                pdf.setTextColor(52, 73, 94);
                pdf.setFont('helvetica', 'normal');
                pdf.text(` ${cocktail.glassware}`, margin + 35, yOffset);
                
                yOffset += 6;
                
                pdf.setTextColor(44, 62, 80);
                pdf.setFont('helvetica', 'bold');
                pdf.text('GARNISH:', margin, yOffset);
                pdf.setTextColor(52, 73, 94);
                pdf.setFont('helvetica', 'normal');
                pdf.text(` ${cocktail.garnish}`, margin + 35, yOffset);
                
                yOffset += 8;

                pdf.setTextColor(44, 62, 80);
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.text('METHOD', margin, yOffset);
                
                yOffset += 6;
                
                const methodLines = pdf.splitTextToSize(cocktail.method, pdf.internal.pageSize.width - 40);
                pdf.setTextColor(52, 73, 94);
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                pdf.text(methodLines, margin + 5, yOffset);
                
                yOffset += methodLines.length * 5 + 15;
            }

            pdf.save(`${venue.name}_Cocktail_Specs.pdf`);
            showToast(` Specs PDF generated for ${cocktails.length} cocktails`);
        }

        // Initialize
        populateVenueDropdown();
        renderVenuesGrid();
        updateFavoritesList();

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
            if (event.target.classList.contains('component-detail-modal')) {
                event.target.style.display = 'none';
            }
            if (event.target.classList.contains('pdf-preview-modal')) {
                event.target.style.display = 'none';
            }
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768) {
                if (!sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                    sidebar.classList.remove('active');
                }
            }
        });
    </script>
</body>
</html>
